<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ben Sandivar</title>

  <!-- Where build.json lives (relative to this HTML file) -->
  <script>window.BUILD_JSON_PATH = 'build.json';</script>

  <!-- Favicons -->
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/BenS-UI/portfolio/cfc0bc646dc8f7cb21379d516f1b1ca0c0f85e06/B-logo-a.svg" />
  <link rel="shortcut icon" href="https://raw.githubusercontent.com/BenS-UI/portfolio/cfc0bc646dc8f7cb21379d516f1b1ca0c0f85e06/B-logo-a.svg" type="image/png" />

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Gabarito:wght@400;700;900&family=Geologica:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet" />

  <!-- Core libs available globally -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js" defer></script>

  <!-- GLOBAL THEME + BASE CSS (keep minimal; components carry their own CSS) -->
  <style id="global-css">
    /* RESET */
    * { margin:0; padding:0; box-sizing:border-box; }

    /* HTML/BODY */
    html, body {
      font-family: 'Geologica', sans-serif;
      min-height: 100vh;
      background: var(--color-body-bg);
      color: var(--color-primary);
      overflow-x: hidden;
    }

    /* Variables (light + dark) */
    :root {
      --color-primary-light:#14213d;
      --color-secondary-light:#f6f8fa;
      --color-accent-light:#0c7b93;
      --color-border-light:#d9dee8;
      --color-shadow-light:rgba(0,0,0,0.08);
      --color-text-light:#425066;
      --color-body-bg-light:#ffffff;
      --color-navbar-bg-light:rgba(255,255,255,0.15);
      --color-navbar-hover-bg-light:rgba(255,255,255,0.35);
      --color-blob-light:#5f41a7;

      --color-primary-dark:#d8dee9;
      --color-secondary-dark:#1e2748;
      --color-accent-dark:#6f78ff;
      --color-border-dark:#37456b;
      --color-shadow-dark:rgba(0,0,0,0.5);
      --color-text-dark:#a8b2d2;
      --color-body-bg-dark:#0e1423;
      --color-navbar-bg-dark:rgba(14,20,35,0.5);
      --color-navbar-hover-bg-dark:rgba(14,20,35,0.8);
      --color-blob-dark:#2f235a;

      /* active theme tokens */
      --color-primary: var(--color-primary-light);
      --color-secondary: var(--color-secondary-light);
      --color-accent: var(--color-accent-light);
      --color-border: var(--color-border-light);
      --color-shadow: var(--color-shadow-light);
      --color-text: var(--color-text-light);
      --color-body-bg: var(--color-body-bg-light);
      --color-navbar-bg: var(--color-navbar-bg-light);
      --color-navbar-hover-bg: var(--color-navbar-hover-bg-light);
      --color-blob: var(--color-blob-light);

      --font-heading: 'Gabarito', sans-serif;
      --radius: 50px;
      --transition: all .3s ease;
      --spacing: .5rem;

      --content-max: min(75vw, 1200px);
    }

    /* Dark Theme switch */
    body[data-theme="dark"] {
      --color-primary: var(--color-primary-dark);
      --color-secondary: var(--color-secondary-dark);
      --color-accent: var(--color-accent-dark);
      --color-border: var(--color-border-dark);
      --color-shadow: var(--color-shadow-dark);
      --color-text: var(--color-text-dark);
      --color-body-bg: var(--color-body-bg-dark);
      --color-navbar-bg: var(--color-navbar-bg-dark);
      --color-navbar-hover-bg: var(--color-navbar-hover-bg-dark);
      --color-blob: var(--color-blob-dark);
    }

    /* Base type only (components can override sizes) */
    h1, h2, h3, h4 { font-family: var(--font-heading); color: var(--color-primary); }
    h1 { font-weight: 900; line-height: 1.2; }
    h2 { font-weight: 900; line-height: 1.3; }
    h3 { font-weight: 700; }
    h4 { font-weight: 700; }
    p  { color: var(--color-text); line-height: 1.8; }

    /* Keep common inner widths centered */
    .container,
    .page-header,
    .footer-text,
    .nav-container,
    .hero-content,
    .projects-grid,
    .music-grid,
    .about-intro,
    .skills-grid,
    .about-bio,
    .contact-grid {
      max-width: var(--content-max);
      margin-left: auto;
      margin-right: auto;
    }

    /* Ensure the nav layer is on top of hero canvases etc. */
    nav[data-mount="nav"] { position: relative; z-index: 1500; }
  </style>

  <!-- Optional extra site-wide stylesheet -->
  <link rel="stylesheet" href="/ben-sandivar-site/styles.css" />
</head>
<body>
  <!-- Mount regions -->
  <header id="header" data-mount="header"></header>
  <nav id="nav" data-mount="nav"></nav>
  <main id="main" data-mount="main"></main>
  <aside id="aside" data-mount="aside"></aside>
  <footer id="footer" data-mount="footer"></footer>

  <!-- Theme Toggle -->
  <div class="theme-toggle-container" style="position:fixed;bottom:2rem;right:2rem;z-index:2000">
    <button id="theme-toggle" style="width:50px;height:50px;border-radius:50%;border:1px solid var(--color-border);background:var(--color-secondary);color:var(--color-primary);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px var(--color-shadow);cursor:pointer">
      <span class="material-symbols-outlined theme-icon">dark_mode</span>
    </button>
  </div>

  <!-- Vendor util available to components -->
  <script src="https://cdn.jsdelivr.net/npm/vanilla-tilt@1.8.1/dist/vanilla-tilt.min.js" defer></script>

  <!-- Site scripts -->
  <script src="/ben-sandivar-site/scripts.js" defer></script>

  <!-- Component loader -->
  <script>
  (async function mountComponents(){
    if (window.__COMPONENT_LOADER_RAN__) return; // guard against double-run
    window.__COMPONENT_LOADER_RAN__ = true;

    const buildHref = window.BUILD_JSON_PATH || 'build.json';
    const basePath = new URL('./', window.location.href);

    const fetchText = (url) => fetch(url, { cache: 'no-store' }).then(r => {
      if (!r.ok) throw new Error('HTTP ' + r.status + ' for ' + url);
      return r.text();
    });

    // Remove any previously mounted components (prevents duplicates on hot-reload)
    document.querySelectorAll('[data-mount]').forEach(region => {
      region.querySelectorAll('[data-component]').forEach(n => n.remove());
    });

    // Fix relative URLs inside a fragment (href, src, srcset, poster, inline CSS url(...))
    function fixRelativeURLs(root, compURL) {
      const ABS = (u) => { try { return new URL(u, compURL).href; } catch(_) { return u; } };

      root.querySelectorAll('[src]').forEach(el => { el.src = ABS(el.getAttribute('src')); });
      root.querySelectorAll('[href]').forEach(el => {
        const tag = el.tagName.toLowerCase();
        // donâ€™t absolutize fragment-only links
        const href = el.getAttribute('href');
        if (href && !href.startsWith('#')) el.setAttribute('href', ABS(href));
      });
      root.querySelectorAll('[poster]').forEach(el => { el.poster = ABS(el.getAttribute('poster')); });
      root.querySelectorAll('[data-src]').forEach(el => { el.setAttribute('data-src', ABS(el.getAttribute('data-src'))); });

      // srcset handling
      root.querySelectorAll('[srcset]').forEach(el => {
        const raw = el.getAttribute('srcset') || '';
        const fixed = raw.split(',').map(part => {
          const [url, w] = part.trim().split(/\s+/, 2);
          return url ? [ABS(url), w].filter(Boolean).join(' ') : '';
        }).filter(Boolean).join(', ');
        el.setAttribute('srcset', fixed);
      });

      // inline <style> url(...) rewriting
      root.querySelectorAll('style').forEach(styleEl => {
        const css = styleEl.textContent;
        const rewritten = css.replace(/url\(\s*(['"]?)([^'")]+)\1\s*\)/g, (m, q, url) => {
          if (/^(data:|blob:|http:|https:|#)/i.test(url)) return m;
          return `url("${ABS(url)}")`;
        });
        if (rewritten !== css) styleEl.textContent = rewritten;
      });
    }

    try {
      const buildURL = new URL(buildHref, basePath);
      const buildRaw = await fetchText(buildURL);
      const build = JSON.parse(buildRaw);
      const order = Array.isArray(build.order) ? build.order : [];
      const byId = new Map((build.components || []).map(c => [c.id, c]));
      const mountedIds = new Set();

      for (const id of order) {
        const conf = byId.get(id);
        if (!conf || conf.active !== true) continue;
        if (mountedIds.has(id)) continue; // safety

        const mountSel = conf.mount || 'main';
        const region = document.querySelector(`[data-mount="${mountSel}"]`) || document.querySelector('#main');
        if (!region) continue;

        const filePath = (conf.file || '').trim();
        if (!filePath) continue;

        try {
          const compURL = new URL(filePath, buildURL);
          const html = await fetchText(compURL);

          // Parse into template
          const tpl = document.createElement('template');
          tpl.innerHTML = html;

          // Ensure stylesheets resolve correctly
          tpl.content.querySelectorAll('link[rel="stylesheet"][href]').forEach(link => {
            try { link.href = new URL(link.getAttribute('href'), compURL).href; } catch (_) {}
          });

          // Fix all other relative URLs and inline CSS url(...)
          fixRelativeURLs(tpl.content, compURL);

          // Extract scripts so they actually execute after insertion
          const scriptNodes = Array.from(tpl.content.querySelectorAll('script'));
          const scripts = scriptNodes.map(old => {
            const s = document.createElement('script');
            for (const { name, value } of Array.from(old.attributes)) {
              if (name === 'src') {
                try { s.setAttribute('src', new URL(value, compURL).href); }
                catch (_) { s.setAttribute('src', value); }
              } else {
                s.setAttribute(name, value);
              }
            }
            if (!s.hasAttribute('defer') && !s.hasAttribute('async')) {
              // inline scripts should run immediately after we append them
            }
            if (old.textContent) s.textContent = old.textContent;
            old.remove();
            return s;
          });

          // Wrap & append DOM
          const wrapper = document.createElement('div');
          wrapper.setAttribute('data-component', id);
          wrapper.appendChild(tpl.content.cloneNode(true));
          region.appendChild(wrapper);

          // Now append scripts so they execute
          for (const s of scripts) {
            // Force inline scripts to re-evaluate by creating fresh nodes
            const fresh = document.createElement('script');
            for (const { name, value } of Array.from(s.attributes)) fresh.setAttribute(name, value);
            if (s.textContent) fresh.textContent = s.textContent;
            wrapper.appendChild(fresh);
          }

          mountedIds.add(id);
        } catch (err) {
          console.error('Component failed:', id, err);
          const fallback = document.createElement('section');
          fallback.setAttribute('data-component', id);
          fallback.innerHTML = `<!-- Failed to load ${id}: ${(conf && conf.file) || 'unknown'} -->`;
          region.appendChild(fallback);
        }
      }
    } catch (e) {
      console.error('Mount error:', e);
      const main = document.querySelector('#main');
      if (main) main.innerHTML = '<div style="padding:1rem">build.json missing or invalid.</div>';
    }
  })();

  // Simple theme toggle
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('#theme-toggle');
    if (!btn) return;
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
  });
  </script>
</body>
</html>
