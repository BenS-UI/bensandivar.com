<section id="music" class="music-player fade-in" data-split="music">
  <div class="page-header">
    <h2>Music</h2>
    <p>Albums and tracks in a simple player.</p>
  </div>

  <div class="music-shell">
    <!-- sound-reactive overlay (behind content) -->
    <div class="aurora-layer" aria-hidden="true">
      <canvas id="aurora"></canvas>
    </div>

    <!-- mode lights (toggle views) -->
    <div class="mode-lights" role="group" aria-label="View switch">
      <button id="light-list" class="light on" aria-label="List view"></button>
      <button id="light-track" class="light" aria-label="Track view"></button>
      <div class="hint" role="note">Tap a dot to switch views</div>
    </div>

    <!-- scrollable area (list only) -->
    <div class="views-wrap" id="viewsWrap">
      <!-- LIST VIEW -->
      <div id="albums-view" class="albums-view" aria-live="polite"></div>

      <!-- TRACK VIEW (mutually exclusive) -->
      <div id="track-view" class="track-view hidden">
        <div class="track-stage">
          <div class="stage-art-wrap">
            <img id="stage-art" src="" alt="Album art">
          </div>
          <div class="stage-meta">
            <h3 id="stage-title">—</h3>
            <p id="stage-album">—</p>
          </div>
        </div>
      </div>
    </div>

    <!-- PLAYER BAR -->
    <div class="player-bar glass">
      <div class="now">
        <img id="nowArt" src="" alt="" class="now-art">
        <div class="now-meta">
          <span id="nowTitle">—</span>
          <small id="nowAlbum">—</small>
        </div>
      </div>

      <div class="controls">
        <!-- Global Play All -->
        <button class="icon-btn" id="playAllBtn" title="Play entire library">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
            <path d="M5 7h8M5 12h14M5 17h10" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
            <path d="M17 8v8l5-4z" fill="currentColor"/>
          </svg>
        </button>

        <button class="icon-btn" id="prevBtn" title="Previous">
          <svg viewBox="0 0 24 24" width="18" height="18"><path d="M6 6v12M18 6l-8 6 8 6V6z" fill="currentColor"/></svg>
        </button>

        <button class="icon-btn primary" id="playPauseBtn" title="Play / Pause">
          <svg id="iconPlay" viewBox="0 0 24 24" width="20" height="20"><path d="M8 5v14l11-7z" fill="currentColor"/></svg>
          <svg id="iconPause" viewBox="0 0 24 24" width="20" height="20" hidden><path d="M7 5h4v14H7zM13 5h4v14h-4z" fill="currentColor"/></svg>
        </button>

        <button class="icon-btn" id="nextBtn" title="Next">
          <svg viewBox="0 0 24 24" width="18" height="18"><path d="M18 6v12M6 6l8 6-8 6V6z" fill="currentColor"/></svg>
        </button>
      </div>

      <div class="progress">
        <span id="currTime" class="time">0:00</span>
        <div class="bar">
          <input id="seek" type="range" min="0" max="1000" value="0" step="1" aria-label="Seek">
          <div class="neon"></div>
        </div>
        <span id="durTime" class="time">0:00</span>
      </div>

      <audio id="audio" preload="metadata"></audio>
    </div>
  </div>

  <script>
  (function(){
    // -------- Data
    const tracks = [
      { title: "Rain",                src: "assets/tracks/Track 1.mp3", album: "Musings",               art: "assets/tracks/Musings.jpg" },
      { title: "Sonata",              src: "assets/tracks/Track 2.mp3", album: "Musings",               art: "assets/tracks/Musings.jpg" },
      { title: "Münchhausen",         src: "assets/tracks/Track 3.mp3", album: "Musings",               art: "assets/tracks/Musings.jpg" },
      { title: "Growing Old",         src: "assets/tracks/Track 4.mp3", album: "Musings",               art: "assets/tracks/Musings.jpg" },
      { title: "The Adventure Begins",src: "assets/tracks/Track 5.mp3", album: "The Adventure Begins",  art: "assets/tracks/Musings.jpg" } // swap art later
    ];

    // Group + sort albums by track count
    const albumsMap = {};
    tracks.forEach(t => {
      if (!albumsMap[t.album]) albumsMap[t.album] = { art: t.art, tracks: [] };
      albumsMap[t.album].tracks.push(t);
    });
    const albums = Object.entries(albumsMap).sort((a,b)=> b[1].tracks.length - a[1].tracks.length);

    // -------- Elements
    const shell      = document.querySelector('.music-shell');
    const viewsWrap  = document.getElementById('viewsWrap');
    const albumsView = document.getElementById('albums-view');
    const trackView  = document.getElementById('track-view');
    const lightList  = document.getElementById('light-list');
    const lightTrack = document.getElementById('light-track');

    const audio   = document.getElementById('audio');
    const playBtn = document.getElementById('playPauseBtn');
    const iconPlay  = document.getElementById('iconPlay');
    const iconPause = document.getElementById('iconPause');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const playAllBtn = document.getElementById('playAllBtn');
    const seek   = document.getElementById('seek');
    const neon   = document.querySelector('.bar .neon');
    const currTime = document.getElementById('currTime');
    const durTime  = document.getElementById('durTime');
    const nowArt   = document.getElementById('nowArt');
    const nowTitle = document.getElementById('nowTitle');
    const nowAlbum = document.getElementById('nowAlbum');

    const stageArt   = document.getElementById('stage-art');
    const stageTitle = document.getElementById('stage-title');
    const stageAlbum = document.getElementById('stage-album');
    const trackStage = document.querySelector('.track-stage');

    const auroraCanvas = document.getElementById('aurora');
    const auroraCtx    = auroraCanvas.getContext('2d');
    const auroraLayer  = document.querySelector('.aurora-layer');

    // -------- Render list view
    function renderAlbums(){
      albumsView.innerHTML = albums.map(([name, data])=>{
        const items = data.tracks.map(t => `
          <li class="track-row" data-src="${t.src}" data-title="${t.title}" data-album="${name}" data-art="${data.art}">
            <span class="t-title">${t.title}</span>
            <span class="t-time">--:--</span>
          </li>`).join('');

        return `
          <article class="album-row" data-album="${name}">
            <div class="album-art-col">
              <img class="album-art" src="${data.art}" alt="${name} album art">
            </div>
            <div class="playlist-col">
              <header class="playlist-head">
                <h3>${name}</h3>
                <button class="icon-btn play-all" title="Play all in ${name}">
                  <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                    <path d="M5 7h8M5 12h14M5 17h10" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
                    <path d="M17 8v8l5-4z" fill="currentColor"/>
                  </svg>
                </button>
              </header>
              <ul class="track-list">${items}</ul>
            </div>
          </article>`;
      }).join('');
    }
    renderAlbums();

    // Load durations
    albumsView.querySelectorAll('.track-row').forEach(li=>{
      const a = new Audio();
      a.src = li.dataset.src;
      a.preload = 'metadata';
      a.addEventListener('loadedmetadata', ()=>{
        li.querySelector('.t-time').textContent = formatTime(a.duration);
      });
    });

    // -------- Player state
    let scope = 'album';        // 'album' | 'all'
    let queue = [];             // current queue
    let index = 0;              // current index in queue

    const allQueue = albums.flatMap(([n,d]) => d.tracks.map(t=>t));

    function setAlbumQueue(albumName){
      scope='album';
      queue = albumsMap[albumName].tracks.slice();
      index = 0;
      updateActiveAlbum(albumName);
    }

    function updateActiveAlbum(name){
      document.querySelectorAll('.album-row').forEach(row=>{
        row.classList.toggle('active', row.dataset.album===name);
      });
    }

    function loadTrackBySrc(src){
      index = queue.findIndex(t => t.src===src);
      if (index<0) index = 0;
      const t = queue[index];
      audio.src = t.src;

      nowArt.src   = albumsMap[t.album].art;
      nowTitle.textContent = t.title;
      nowAlbum.textContent = t.album;

      stageArt.src   = albumsMap[t.album].art;
      stageTitle.textContent = t.title;
      stageAlbum.textContent = t.album;
      setTimeout(()=> dominantToStage(stageArt, trackStage), 0);

      document.querySelectorAll('.track-row').forEach(r=>{
        r.classList.toggle('active', r.dataset.src===t.src);
      });
    }

    function play(){ audio.play(); iconPlay.hidden=true; iconPause.hidden=false; }
    function pause(){ audio.pause(); iconPlay.hidden=false; iconPause.hidden=true; }

    function next(){ index=(index+1)%queue.length; loadTrackBySrc(queue[index].src); play(); }
    function prev(){ index=(index-1+queue.length)%queue.length; loadTrackBySrc(queue[index].src); play(); }

    // List interactions
    albumsView.addEventListener('click', e=>{
      const row = e.target.closest('.track-row');
      const playAll = e.target.closest('.play-all');
      const albumRow = e.target.closest('.album-row');

      if (playAll && albumRow){
        setAlbumQueue(albumRow.dataset.album);
        loadTrackBySrc(queue[0].src);
        play();
        return;
      }
      if (row){
        if (scope!=='album' || queue.length===0 || (queue[0].album !== row.dataset.album)){
          setAlbumQueue(row.dataset.album);
        }
        loadTrackBySrc(row.dataset.src);
        play();
      }
    });

    // Global Play All
    playAllBtn.addEventListener('click', ()=>{
      scope='all';
      queue = allQueue.slice();
      index = 0;
      updateActiveAlbum('');
      loadTrackBySrc(queue[0].src);
      play();
      playAllBtn.classList.add('active');
      setTimeout(()=> playAllBtn.classList.remove('active'), 350);
    });

    // Transport
    playBtn.addEventListener('click', ()=> audio.paused ? play() : pause());
    nextBtn.addEventListener('click', next);
    prevBtn.addEventListener('click', prev);

    // Progress
    audio.addEventListener('timeupdate', ()=>{
      if (isFinite(audio.duration)){
        seek.value = Math.floor(1000 * audio.currentTime / audio.duration);
        neon.style.setProperty('--pct', (audio.currentTime / audio.duration) * 100);
        currTime.textContent = formatTime(audio.currentTime);
        durTime.textContent  = formatTime(audio.duration);
      }
    });
    seek.addEventListener('input', ()=>{
      if (isFinite(audio.duration)){
        audio.currentTime = (seek.value/1000) * audio.duration;
      }
    });
    audio.addEventListener('ended', ()=> {
      stopAurora(true); // fade out
      next();
    });

    // -------- Mode switching (mutually exclusive) + scroll rule
    function setMode(list){
      const isList = !!list;
      albumsView.classList.toggle('hidden', !isList);
      trackView.classList.toggle('hidden', isList);
      lightList.classList.toggle('on', isList);
      lightTrack.classList.toggle('on', !isList);
      shell.classList.toggle('track-bg', !isList);
      // list scrolls; track doesn't
      viewsWrap.classList.toggle('no-scroll', !isList);
      viewsWrap.scrollTop = 0;
    }
    lightList.addEventListener('click', ()=> setMode(true));
    lightTrack.addEventListener('click', ()=> setMode(false));

    // -------- Dominant color → track background
    function dominantToStage(img, host){
      const c=document.createElement('canvas'), ctx=c.getContext('2d',{willReadFrequently:true});
      const w=48,h=48; c.width=w; c.height=h;
      try{
        ctx.drawImage(img,0,0,w,h);
        const data=ctx.getImageData(0,0,w,h).data;
        const bins=new Map();
        for(let i=0;i<data.length;i+=4){
          const r=data[i],g=data[i+1],b=data[i+2],a=data[i+3];
          if(a<200) continue;
          const max=Math.max(r,g,b), min=Math.min(r,g,b);
          if(max<40 || (max-min)<12) continue; // skip dark/gray
          const key=(r>>4)+','+(g>>4)+','+(b>>4);
          bins.set(key,(bins.get(key)||0)+1);
        }
        let best=null,count=0;
        bins.forEach((v,k)=>{ if(v>count){count=v;best=k;} });
        if(best){
          const [R,G,B]=best.split(',').map(n=>parseInt(n,10)*16+8);
          host.style.setProperty('--stage-bg', `radial-gradient(120% 140% at 50% 25%, rgba(${R},${G},${B},.28), rgba(0,0,0,.9))`);
        }
      }catch(e){}
    }

    // -------- Aurora overlay (sound-reactive)
    let acx, srcNode, analyser;
    let rafId = null;
    let showTimer = null;
    let hoverTimer = null;
    let silenceTimer = null;
    let overlayOn = false;
    let overlaySuppressed = false;

    function ensureAudioGraph(){
      if (acx) return;
      acx = new (window.AudioContext || window.webkitAudioContext)();
      srcNode = acx.createMediaElementSource(audio);
      analyser = acx.createAnalyser();
      analyser.fftSize = 2048;
      analyser.smoothingTimeConstant = 0.85;
      srcNode.connect(analyser);
      analyser.connect(acx.destination);
    }

    function sizeCanvas(){
      const r = auroraLayer.getBoundingClientRect();
      auroraCanvas.width  = Math.max(1, Math.floor(r.width));
      auroraCanvas.height = Math.max(1, Math.floor(r.height));
    }
    sizeCanvas();
    window.addEventListener('resize', sizeCanvas);

    // palette management (3..7 colors, avoid harsh pink)
    let palette = genPalette();
    let targetPalette = genPalette();
    let paletteT = 0;

    function genPalette(){
      const n = Math.floor(3 + Math.random()*5); // 3..7
      const cols = [];
      let base = Math.random() * 360;
      for (let i=0;i<n;i++){
        let h = (base + i*(240/n) + Math.random()*20) % 360;
        // avoid pink band roughly 315..345
        if (h>315 && h<345) h = (h+40)%360;
        const s = 70 + Math.random()*25;
        const l = 52 + Math.random()*10;
        cols.push({h,s,l});
      }
      return cols;
    }
    function lerp(a,b,t){ return a + (b-a)*t; }
    function hsl(h,s,l){ return `hsla(${h.toFixed(1)} ${s.toFixed(1)}% ${l.toFixed(1)}% / 1)`; }

    function startAurora(){
      if (overlayOn) return;
      overlayOn = true;
      auroraLayer.classList.add('on'); // CSS fades in (5s)
      if (!acx) ensureAudioGraph();
      animateAurora();
    }
    function stopAurora(slowFade){
      overlayOn = false;
      auroraLayer.classList.remove('on'); // CSS fades out (5s)
      if (rafId){ cancelAnimationFrame(rafId); rafId=null; }
      if (slowFade){ /* handled by CSS */ }
    }
    function scheduleShow(){
      if (overlayOn || overlaySuppressed) return;
      clearTimeout(showTimer);
      showTimer = setTimeout(()=>{ if (!audio.paused) startAurora(); }, 20000);
    }

    // Hover 5s → hide overlay
    shell.addEventListener('mouseenter', ()=>{
      if (!overlayOn) return;
      clearTimeout(hoverTimer);
      hoverTimer = setTimeout(()=>{ stopAurora(true); overlaySuppressed = true; }, 5000);
    });
    shell.addEventListener('mouseleave', ()=>{
      clearTimeout(hoverTimer);
      if (!audio.paused){ overlaySuppressed = false; scheduleShow(); }
    });

    // Play / pause hooks
    audio.addEventListener('play', ()=>{
      ensureAudioGraph();
      scheduleShow();
    });
    audio.addEventListener('pause', ()=>{
      clearTimeout(showTimer);
      stopAurora(true);
    });

    // Silence detection (avg level under threshold for ~2s)
    function checkSilence(){
      if (!analyser) return;
      const buf = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(buf);
      let sum = 0;
      for (let i=0;i<buf.length;i++) sum += buf[i];
      const avg = sum / buf.length;
      if (avg < 5){ // very low level
        if (!silenceTimer) {
          silenceTimer = setTimeout(()=> stopAurora(true), 2000);
        }
      } else {
        clearTimeout(silenceTimer); silenceTimer = null;
      }
    }

    // Aurora draw
    const blobs = Array.from({length:7}, ()=>({
      x: Math.random(), y: Math.random(), r: 0.18 + Math.random()*0.25,
      vx: (Math.random()*0.6-0.3)*0.0008, vy: (Math.random()*0.6-0.3)*0.0008
    }));

    function animateAurora(){
      if (!overlayOn) return;
      rafId = requestAnimationFrame(animateAurora);
      sizeCanvas();
      const w = auroraCanvas.width, h = auroraCanvas.height;
      auroraCtx.clearRect(0,0,w,h);

      // audio bands
      const f = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(f);
      const bass = bandEnergy(f, 20, 150);
      const mid  = bandEnergy(f, 400, 2000);
      const treb = bandEnergy(f, 4000, 12000);
      checkSilence();

      // update palette slowly, morph every ~10s
      paletteT += 0.002; // slow
      if (paletteT >= 1){ palette = targetPalette; targetPalette = genPalette(); paletteT = 0; }
      const curr = blendPalettes(palette, targetPalette, paletteT);

      // draw blobs (count varies with palette size)
      const N = Math.max(3, Math.min(7, curr.length));
      for (let i=0;i<N;i++){
        const b = blobs[i];
        b.x += (b.vx + 0.0004 * (treb/255 - 0.25));
        b.y += (b.vy + 0.0003 * (mid/255  - 0.25));
        if (b.x < 0 || b.x > 1) b.vx *= -1;
        if (b.y < 0 || b.y > 1) b.vy *= -1;

        const cx = b.x * w, cy = b.y * h;
        const baseR = b.r * Math.min(w,h);
        const r = baseR * (0.8 + (bass/255)*0.6);

        const g = auroraCtx.createRadialGradient(cx, cy, 0, cx, cy, r);
        const col = curr[i % curr.length];
        g.addColorStop(0.0, colorWithAlpha(col, 0.85));
        g.addColorStop(0.6, colorWithAlpha(col, 0.35));
        g.addColorStop(1.0, 'rgba(0,0,0,0)');
        auroraCtx.fillStyle = g;
        auroraCtx.beginPath();
        auroraCtx.arc(cx, cy, r, 0, Math.PI*2);
        auroraCtx.fill();
      }
    }

    function bandEnergy(arr, fLow, fHigh){
      // map freq bins (approx) to indices
      const nyq = acx.sampleRate / 2;
      const low = Math.floor(arr.length * (fLow/nyq));
      const high= Math.min(arr.length-1, Math.ceil(arr.length * (fHigh/nyq)));
      let s=0,c=0;
      for (let i=low;i<=high;i++){ s+=arr[i]; c++; }
      return c? s/c : 0;
    }
    function blendPalettes(a,b,t){
      const n = Math.max(a.length, b.length);
      const out=[];
      for(let i=0;i<n;i++){
        const A = a[i % a.length], B = b[i % b.length];
        out.push({ h: lerp(A.h, B.h, t), s: lerp(A.s, B.s, t), l: lerp(A.l, B.l, t) });
      }
      return out;
    }
    function colorWithAlpha(c, alpha){ return `hsla(${c.h.toFixed(1)} ${c.s.toFixed(1)}% ${c.l.toFixed(1)}% / ${alpha})`; }

    // Hover 5s to disable overlay (already handled above)

    // -------- Boot
    setAlbumQueue(albums[0][0]);
    loadTrackBySrc(albumsMap[albums[0][0]].tracks[0].src);
    setMode(true);
  })();

  // helpers
  function formatTime(t){ const m=Math.floor(t/60); const s=Math.floor(t%60).toString().padStart(2,'0'); return `${m}:${s}`; }
  </script>
</section>
