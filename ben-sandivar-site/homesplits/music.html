<section id="music" class="music-player fade-in" data-split="music">
  <div class="page-header">
    <h2>Music</h2>
    <p>Albums and tracks with a minimal player.</p>

    <div class="player-mode-toggle">
      <button id="mode-list" class="ui-btn active" aria-pressed="true" title="List mode">
        <!-- list icon -->
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path d="M4 6h16M4 12h16M4 18h10" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
        List
      </button>
      <button id="mode-track" class="ui-btn" aria-pressed="false" title="Track mode">
        <!-- disc icon -->
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="12" cy="12" r="2" fill="currentColor"/></svg>
        Track
      </button>
    </div>
  </div>

  <div class="music-shell">
    <!-- LIST MODE -->
    <div id="albums-view" class="albums-view" aria-live="polite"></div>

    <!-- TRACK MODE -->
    <div id="track-view" class="track-view" hidden>
      <div class="track-stage">
        <div class="stage-art-wrap">
          <img id="stage-art" src="" alt="Album art" />
        </div>
        <div class="stage-meta">
          <h3 id="stage-title">—</h3>
          <p id="stage-album">—</p>
        </div>
      </div>
    </div>

    <!-- GLOBAL PLAYER (visible in both modes; sits at bottom) -->
    <div class="player-bar glass">
      <div class="controls">
        <button class="icon-btn" id="prevBtn" title="Previous">
          <!-- prev -->
          <svg viewBox="0 0 24 24" width="18" height="18"><path d="M6 6v12M18 6l-8 6 8 6V6z" fill="currentColor"/></svg>
        </button>
        <button class="icon-btn primary" id="playPauseBtn" title="Play / Pause">
          <!-- play -->
          <svg id="iconPlay" viewBox="0 0 24 24" width="20" height="20"><path d="M8 5v14l11-7z" fill="currentColor"/></svg>
          <!-- pause -->
          <svg id="iconPause" viewBox="0 0 24 24" width="20" height="20" hidden><path d="M7 5h4v14H7zM13 5h4v14h-4z" fill="currentColor"/></svg>
        </button>
        <button class="icon-btn" id="nextBtn" title="Next">
          <!-- next -->
          <svg viewBox="0 0 24 24" width="18" height="18"><path d="M18 6v12M6 6l8 6-8 6V6z" fill="currentColor"/></svg>
        </button>
      </div>

      <div class="progress">
        <span id="currTime" class="time">0:00</span>
        <div class="bar">
          <input id="seek" type="range" min="0" max="1000" value="0" step="1" aria-label="Seek"/>
          <div class="neon"></div>
        </div>
        <span id="durTime" class="time">0:00</span>
      </div>

      <div class="now">
        <div class="now-art">
          <img id="nowArt" src="" alt="Now playing art" />
        </div>
        <div class="now-meta">
          <span id="nowTitle">—</span>
          <small id="nowAlbum">—</small>
        </div>
      </div>

      <audio id="audio" preload="metadata"></audio>
    </div>
  </div>

  <script>
  (function(){
    // Data
    const tracks = [
      { title: "Rain",               src: "assets/tracks/Track 1.mp3", album: "Musings",               art: "assets/tracks/Musings.jpg" },
      { title: "Sonata",             src: "assets/tracks/Track 2.mp3", album: "Musings",               art: "assets/tracks/Musings.jpg" },
      { title: "Münchhausen",        src: "assets/tracks/Track 3.mp3", album: "Musings",               art: "assets/tracks/Musings.jpg" },
      { title: "Growing Old",        src: "assets/tracks/Track 4.mp3", album: "Musings",               art: "assets/tracks/Musings.jpg" },
      { title: "The Adventure Begins", src: "assets/tracks/Track 5.mp3", album: "The Adventure Begins", art: "assets/tracks/Musings.jpg" } // replace art later
    ];

    // Group by album, sort by track count desc
    const albumsMap = {};
    for (const t of tracks) {
      if (!albumsMap[t.album]) albumsMap[t.album] = { art: t.art, tracks: [] };
      albumsMap[t.album].tracks.push(t);
    }
    const albums = Object.entries(albumsMap).sort((a,b)=> b[1].tracks.length - a[1].tracks.length);

    // Elements
    const shell = document.querySelector('.music-shell');
    const albumsView = document.getElementById('albums-view');
    const trackView  = document.getElementById('track-view');
    const modeListBtn  = document.getElementById('mode-list');
    const modeTrackBtn = document.getElementById('mode-track');

    const audio = document.getElementById('audio');
    const playBtn = document.getElementById('playPauseBtn');
    const iconPlay  = document.getElementById('iconPlay');
    const iconPause = document.getElementById('iconPause');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const seek = document.getElementById('seek');
    const currTime = document.getElementById('currTime');
    const durTime  = document.getElementById('durTime');
    const nowArt   = document.getElementById('nowArt');
    const nowTitle = document.getElementById('nowTitle');
    const nowAlbum = document.getElementById('nowAlbum');

    const stageArt   = document.getElementById('stage-art');
    const stageTitle = document.getElementById('stage-title');
    const stageAlbum = document.getElementById('stage-album');
    const trackStage = document.querySelector('.track-stage');

    // Render albums list
    function renderAlbums(){
      albumsView.innerHTML = albums.map(([name, data]) => {
        const list = data.tracks.map(t => `
          <li class="track-row" data-src="${t.src}" data-title="${t.title}" data-album="${name}" data-art="${data.art}">
            <button class="track-btn" title="Play ${t.title}">
              <!-- play-mini -->
              <svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true"><path d="M8 5v14l11-7z" fill="currentColor"/></svg>
            </button>
            <span class="track-name">${t.title}</span>
          </li>`).join('');

        return `
          <article class="album">
            <header class="album-head">
              <img class="album-art" src="${data.art}" alt="${name} album art">
              <div class="album-meta">
                <h3>${name}</h3>
                <p>${data.tracks.length} track${data.tracks.length>1?'s':''}</p>
              </div>
            </header>
            <ul class="track-list">${list}</ul>
          </article>`;
      }).join('');
    }

    renderAlbums();

    // Player state
    let queue = tracks.slice(); // flat order
    let index = 0;

    function loadTrackBySrc(src){
      index = queue.findIndex(t => t.src === src);
      if (index < 0) index = 0;
      const t = queue[index];
      audio.src = t.src;
      nowArt.src = albumsMap[t.album].art;
      nowTitle.textContent = t.title;
      nowAlbum.textContent = t.album;
      // highlight active
      document.querySelectorAll('.track-row').forEach(li => li.classList.toggle('active', li.dataset.src===t.src));
      // update track mode view too
      stageArt.src = albumsMap[t.album].art;
      stageTitle.textContent = t.title;
      stageAlbum.textContent = t.album;
      // compute dominant color for track mode bg
      setTimeout(()=>dominantToStage(stageArt, trackStage), 0);
    }

    function play(){
      audio.play();
      iconPlay.hidden = true;
      iconPause.hidden = false;
    }
    function pause(){
      audio.pause();
      iconPlay.hidden = false;
      iconPause.hidden = true;
    }

    // Click on track row
    albumsView.addEventListener('click', (e)=>{
      const li = e.target.closest('.track-row');
      if (!li) return;
      loadTrackBySrc(li.dataset.src);
      play();
    });

    // Controls
    playBtn.addEventListener('click', ()=>{
      if (audio.paused) play(); else pause();
    });
    prevBtn.addEventListener('click', ()=>{
      index = (index - 1 + queue.length) % queue.length;
      loadTrackBySrc(queue[index].src);
      play();
    });
    nextBtn.addEventListener('click', ()=>{
      index = (index + 1) % queue.length;
      loadTrackBySrc(queue[index].src);
      play();
    });

    // Progress
    audio.addEventListener('timeupdate', ()=>{
      if (!isNaN(audio.duration)) {
        seek.value = Math.floor(1000 * (audio.currentTime / audio.duration));
        currTime.textContent = formatTime(audio.currentTime);
        durTime.textContent  = formatTime(audio.duration);
      }
    });
    seek.addEventListener('input', ()=>{
      if (!isNaN(audio.duration)) {
        audio.currentTime = (seek.value/1000) * audio.duration;
      }
    });
    audio.addEventListener('ended', ()=> nextBtn.click());

    function formatTime(t){
      const m = Math.floor(t/60); const s = Math.floor(t%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    }

    // Mode toggle
    function setMode(listMode){
      if (listMode) {
        albumsView.hidden = false;
        trackView.hidden  = true;
        modeListBtn.classList.add('active');  modeListBtn.setAttribute('aria-pressed','true');
        modeTrackBtn.classList.remove('active'); modeTrackBtn.setAttribute('aria-pressed','false');
        shell.style.setProperty('--stage-bg', 'transparent');
      } else {
        albumsView.hidden = true;
        trackView.hidden  = false;
        modeTrackBtn.classList.add('active'); modeTrackBtn.setAttribute('aria-pressed','true');
        modeListBtn.classList.remove('active'); modeListBtn.setAttribute('aria-pressed','false');
      }
    }
    modeListBtn.addEventListener('click', ()=> setMode(true));
    modeTrackBtn.addEventListener('click', ()=> setMode(false));

    // Dominant color to stage background (simple quantize)
    function dominantToStage(img, host){
      const c = document.createElement('canvas');
      const ctx = c.getContext('2d', { willReadFrequently: true });
      c.width = 48; c.height = 48; // downsample
      try {
        ctx.drawImage(img, 0, 0, c.width, c.height);
        const data = ctx.getImageData(0,0,c.width,c.height).data;
        const bins = new Map();
        for (let i=0;i<data.length;i+=4){
          const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];
          if (a<200) continue;
          // skip near-black/near-gray to avoid muddy backgrounds
          const max=Math.max(r,g,b), min=Math.min(r,g,b);
          if (max<40 || (max-min)<10) continue;
          const key = (r>>4)+','+(g>>4)+','+(b>>4);
          bins.set(key, (bins.get(key)||0)+1);
        }
        let bestKey=null, bestCount=0;
        bins.forEach((count,key)=>{ if (count>bestCount){bestCount=count;bestKey=key;} });
        if (bestKey){
          const [qr,qg,qb]=bestKey.split(',').map(n=>parseInt(n,10)*16+8);
          host.style.setProperty('--stage-r', qr);
          host.style.setProperty('--stage-g', qg);
          host.style.setProperty('--stage-b', qb);
          shell.style.setProperty('--stage-bg', `rgb(${qr},${qg},${qb})`);
        }
      } catch(e){}
    }

    // Init with first track
    loadTrackBySrc(tracks[0].src);
    setMode(true);
  })();
  </script>
</section>
