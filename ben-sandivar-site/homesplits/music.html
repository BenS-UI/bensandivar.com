<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enhanced Music Player</title>
<style>
/* utils */
[hidden]{display:none!important;}
.hidden{display:none!important;}
.icon-btn svg[hidden]{display:none!important;} /* ensure icons swap */

/* keep music below hero */
section.bucket-hero{ position:relative; z-index:2; }
#music.music-player{
  position:relative !important;
  z-index:1 !important;
  inset:auto !important;
  clear:both;
  display:flow-root;
  contain: layout paint;
}

.music-player{
  margin-top: clamp(24px, 8vh, 120px);
  margin-bottom: 10vh;
  padding: 0 8vw;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.music-shell{
  isolation:isolate;
  width:100%;
  margin:0 auto;
  border-radius:28px;
  position:relative;
  background: radial-gradient(120% 120% at 60% 20%, rgba(255,255,255,.04), rgba(0,0,0,.45));
  border:1px solid rgba(255,255,255,.08);
  box-shadow: 0 8px 22px rgba(0,0,0,.22);
  display:flex;
  flex-direction:column;
  height: clamp(560px, 72vh, 860px);
  padding:2.25rem 2rem 1.25rem;
  overflow:hidden;
}
@media (min-width:1024px){ .music-shell{ width:75%; } }

.page-header{ text-align:center; margin-bottom: 2rem; }

/* view switch */
.mode-lights{ position:absolute; top:.6rem; left:50%; transform:translateX(-50%); display:flex; gap:.5rem; align-items:center; z-index:6; }
.mode-lights .light{
  width:12px; height:12px; border-radius:999px; border:0; cursor:pointer;
  background: radial-gradient(circle at 35% 35%, #7ab8ff 10%, #1f6fff 70%, #0036e8 100%);
  box-shadow: 0 0 10px rgba(47,132,255,.9), 0 0 18px rgba(47,132,255,.5);
  opacity:.65; transition:opacity .2s ease, transform .08s ease;
}
.mode-lights .light.on{ opacity:1; }
.mode-lights .light:active{ transform:scale(.92); }
.mode-lights .hint{
  position:absolute; top:1.6rem; left:50%; transform:translateX(-50%);
  padding:.35rem .6rem; font-size:.72rem; border-radius:10px;
  background: rgba(255,255,255,.12); color: var(--color-primary);
  border:1px solid rgba(255,255,255,.18); backdrop-filter: blur(6px);
  opacity:0; pointer-events:none; transition:opacity .2s ease;
}
.mode-lights:hover .hint{ opacity:1; }

/* layers */
.views-wrap{ flex:1; overflow:auto; padding-top:.25rem; position:relative; z-index:1; }
.views-wrap.no-scroll{ overflow:hidden; }
.aurora-layer{ position:absolute; inset:0; z-index:2; pointer-events:none; border-radius:inherit; overflow:hidden; opacity:0; transition: opacity 5s ease; }
.aurora-layer.on{ opacity:1; }
.aurora-layer canvas{ width:100%; height:100%; display:block; }
.track-stage .stage-art-wrap{ z-index:3; position:relative; }
.player-bar{ position:relative; z-index:4; }

/* list view */
.albums-view{ display:grid; gap:1.75rem; }
.album-row{
  display:grid; grid-template-columns:140px 1fr; gap:1rem;
  background: rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px; padding:1rem;
}
@media (max-width:720px){ .album-row{ grid-template-columns:100px 1fr; } }
.album-art{ width:120px; height:120px; border-radius:12px; object-fit:cover; box-shadow:0 8px 18px rgba(0,0,0,.28); }
.playlist-col{ display:flex; flex-direction:column; gap:.6rem; }
.playlist-head{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
.playlist-head h3{ margin:0; font-size:1.1rem; }
.icon-btn.play-all{
  width:34px; height:34px; border-radius:10px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: var(--color-primary);
  backdrop-filter: blur(6px);
}
.track-list{ list-style:none; margin:0; padding:0; display:grid; gap:.3rem; }
.track-row{
  display:grid; grid-template-columns:1fr auto; align-items:center;
  padding:.45rem .6rem; border-radius:10px; transition:background .2s ease;
}
.track-row:hover{ background: rgba(255,255,255,.05); }
.track-row.active .t-title{ font-weight:700; }
.t-title{ text-align:left; }
.t-time{ text-align:right; opacity:.82; min-width:3.2rem; }

/* track view */
.music-shell.track-bg{
  background: var(--stage-bg, radial-gradient(120% 140% at 50% 25%, rgba(0,0,0,.36), rgba(0,0,0,.9)));
}
.track-view{ border-radius:22px; padding:2rem 1.25rem; }
.track-stage{ display:grid; gap:1rem; justify-items:center; z-index:3; position:relative; }
.stage-art-wrap{
  width:min(42%, 440px); aspect-ratio:1/1; border-radius:18px;
  box-shadow:0 14px 32px rgba(0,0,0,.32);
}
#stage-art{ width:100%; height:100%; object-fit:cover; border-radius:18px; display:block; }
.stage-meta{ text-align:center; }
#stage-title{ margin:.2rem 0 0; font-size:1.15rem; }
#stage-album{ margin:.1rem 0 0; opacity:.75; }

/* player bar */
.player-bar{
  margin-top:1rem;
  display:grid; grid-template-columns:auto 1fr; gap:1rem; align-items:center;
  padding:.85rem 1rem; border-radius:16px; border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06); backdrop-filter: blur(10px);
}
@media (min-width:760px){ .player-bar{ grid-template-columns:auto auto 1fr; } }

.now{ display:grid; grid-template-columns:auto 1fr; gap:.6rem; align-items:center; }
.now-art{ width:40px; height:40px; border-radius:8px; object-fit:cover; box-shadow:0 4px 12px rgba(0,0,0,.25); }
.now-meta{ display:flex; flex-direction:column; line-height:1.1; }
.now-meta small{ opacity:.75; }

.controls{ display:flex; gap:.5rem; align-items:center; }
.icon-btn{
  display:grid; place-items:center; width:36px; height:36px; border-radius:12px;
  border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); color: var(--color-primary);
  transition: box-shadow .2s ease, border-color .2s ease, transform .06s ease;
}
.icon-btn:hover{ border-color: rgba(0,110,255,.5); box-shadow: 0 0 12px rgba(47,132,255,.35); }
.icon-btn:active{ transform:scale(.97); }
.icon-btn.primary{ width:42px; height:42px; color:#fff; background: rgba(0,110,255,.18); border-color: rgba(0,110,255,.55); }
.icon-btn.active{ box-shadow: 0 0 16px rgba(47,132,255,.6); }

/* progress */
.progress{ display:grid; grid-template-columns:auto 1fr auto; gap:.6rem; align-items:center; }
.time{ font-variant-numeric: tabular-nums; opacity:.85; min-width:3ch; text-align:right; }
.bar{ position:relative; height:18px; display:flex; align-items:center; }
.bar-track{ position:absolute; left:0; right:0; height:8px; border-radius:999px; background: rgba(255,255,255,.18); }
.neon{
  --pct:0;
  position:absolute; left:0; height:6px; width: calc(var(--pct) * 1%); border-radius:999px;
  background: linear-gradient(90deg, #0a5bff, #2f84ff);
  box-shadow: 0 0 18px #2f84ff, 0 0 36px rgba(47,132,255,.5);
}
#seek{
  -webkit-appearance:none; appearance:none; width:100%; height:18px; margin:0; background:transparent; position:relative; z-index:1;
}
#seek::-webkit-slider-runnable-track{ height:18px; background:transparent; }
#seek::-moz-range-track{ height:18px; background:transparent; }
#seek::-webkit-slider-thumb{
  -webkit-appearance:none; width:16px; height:16px; border-radius:50%; margin-top:1px;
  background:#fff; border:1px solid rgba(47,132,255,.95); box-shadow:0 0 12px rgba(47,132,255,.9);
}
#seek::-moz-range-thumb{
  width:16px; height:16px; border-radius:50%;
  background:#fff; border:1px solid rgba(47,132,255,.95); box-shadow:0 0 12px rgba(47,132,255,.9);
}

/* dark theme ready */
body[data-theme="dark"] .music-shell{
  background: radial-gradient(120% 120% at 60% 20%, rgba(255,255,255,.02), rgba(0,0,0,.78));
  border-color: rgba(255,255,255,.07);
}
body[data-theme="dark"] .album-row{ background: rgba(255,255,255,.04); border-color: rgba(255,255,255,.08); }
body[data-theme="dark"] .player-bar{ background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.12); }
body[data-theme="dark"] .icon-btn{ background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.14); }
</style>
</head>
<body>

<section id="music" class="music-player fade-in" data-split="music">
  <div class="page-header">
    <h2>Music</h2>
    <p>Albums and tracks in a simple player.</p>
  </div>

  <div class="music-shell">
    <!-- view switch -->
    <div class="mode-lights" role="group" aria-label="View switch">
      <button id="light-list" class="light on" aria-label="List view"></button>
      <button id="light-track" class="light" aria-label="Track view"></button>
      <div class="hint" role="note">Tap a dot to switch views</div>
    </div>

    <!-- content -->
    <div class="views-wrap" id="viewsWrap">
      <div id="albums-view" class="albums-view" aria-live="polite"></div>

      <!-- Track view: art only -->
      <div id="track-view" class="track-view hidden">
        <div class="track-stage">
          <div class="stage-art-wrap">
            <img id="stage-art" src="" alt="Album art">
          </div>
          <div class="stage-meta">
            <h3 id="stage-title">—</h3>
            <p id="stage-album">—</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Aurora overlay (over list, under art + player) -->
    <div class="aurora-layer" aria-hidden="true">
      <canvas id="aurora"></canvas>
    </div>

    <!-- player bar -->
    <div class="player-bar glass">
      <div class="now">
        <img id="nowArt" src="" alt="" class="now-art">
        <div class="now-meta">
          <span id="nowTitle">—</span>
          <small id="nowAlbum">—</small>
        </div>
      </div>

      <div class="controls">
        <button class="icon-btn" id="playAllBtn" title="Play entire library">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
            <path d="M5 7h8M5 12h14M5 17h10" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
            <path d="M17 8v8l5-4z" fill="currentColor"/>
          </svg>
        </button>

        <button class="icon-btn" id="prevBtn" title="Previous">
          <svg viewBox="0 0 24 24" width="18" height="18"><path d="M6 6v12M18 6l-8 6 8 6V6z" fill="currentColor"/></svg>
        </button>

        <!-- PLAY/PAUSE (icon toggles) -->
        <button class="icon-btn primary" id="playPauseBtn" title="Play / Pause" aria-pressed="false">
          <svg id="iconPlay" viewBox="0 0 24 24" width="20" height="20"><path d="M8 5v14l11-7z" fill="currentColor"/></svg>
          <svg id="iconPause" viewBox="0 0 24 24" width="20" height="20" hidden><path d="M7 5h4v14H7zM13 5h4v14h-4z" fill="currentColor"/></svg>
        </button>

        <button class="icon-btn" id="nextBtn" title="Next">
          <svg viewBox="0 0 24 24" width="18" height="18"><path d="M18 6v12M6 6l8 6-8 6V6z" fill="currentColor"/></svg>
        </button>
      </div>

      <div class="progress">
        <span id="currTime" class="time">0:00</span>
        <div class="bar">
          <div class="bar-track"></div>
          <div class="neon"></div>
          <input id="seek" type="range" min="0" max="1000" value="0" step="1" aria-label="Seek">
        </div>
        <span id="durTime" class="time">0:00</span>
      </div>

      <audio id="audio" preload="metadata" crossorigin="anonymous"></audio>
    </div>
  </div>

  <script>
  (function(){
    /* ---------- DATA ---------- */
    const tracks = [
      { title:"Rain",        src:"assets/tracks/Track 1.mp3", album:"Musings",              art:"assets/tracks/Musings.jpg" },
      { title:"Sonata",      src:"assets/tracks/Track 2.mp3", album:"Musings",              art:"assets/tracks/Musings.jpg" },
      { title:"Münchhausen", src:"assets/tracks/Track 3.mp3", album:"Musings",              art:"assets/tracks/Musings.jpg" },
      { title:"Growing Old", src:"assets/tracks/Track 4.mp3", album:"Musings",              art:"assets/tracks/Musings.jpg" },
      { title:"The Adventure Begins", src:"assets/tracks/Track 5.mp3", album:"The Adventure Begins", art:"assets/tracks/Musings.jpg" }
    ];

    const albumsMap = {};
    tracks.forEach(t => {
      if (!albumsMap[t.album]) albumsMap[t.album] = { art:t.art, tracks:[] };
      albumsMap[t.album].tracks.push(t);
    });
    const albums = Object.entries(albumsMap).sort((a,b)=> b[1].tracks.length - a[1].tracks.length);

    /* ---------- ELTS ---------- */
    const shell      = document.querySelector('.music-shell');
    const viewsWrap  = document.getElementById('viewsWrap');
    const albumsView = document.getElementById('albums-view');
    const trackView  = document.getElementById('track-view');
    const lightList  = document.getElementById('light-list');
    const lightTrack = document.getElementById('light-track');

    const audio   = document.getElementById('audio');
    const playBtn = document.getElementById('playPauseBtn');
    const iconPlay  = document.getElementById('iconPlay');
    const iconPause = document.getElementById('iconPause');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const playAllBtn = document.getElementById('playAllBtn');
    const seek   = document.getElementById('seek');
    const neon   = document.querySelector('.bar .neon');
    const currTime = document.getElementById('currTime');
    const durTime  = document.getElementById('durTime');
    const nowArt   = document.getElementById('nowArt');
    const nowTitle = document.getElementById('nowTitle');
    const nowAlbum = document.getElementById('nowAlbum');
    const stageArt = document.getElementById('stage-art');
    const stageTitle = document.getElementById('stage-title');
    const stageAlbum = document.getElementById('stage-album');
    const trackStage = document.querySelector('.track-stage');

    /* ---------- RENDER LIST ---------- */
    function renderAlbums(){
      albumsView.innerHTML = albums.map(([name, data])=>{
        const items = data.tracks.map(t => `
          <li class="track-row" data-src="${t.src}" data-title="${t.title}" data-album="${name}" data-art="${data.art}">
            <span class="t-title">${t.title}</span>
            <span class="t-time">--:--</span>
          </li>`).join('');
        return `
          <article class="album-row" data-album="${name}">
            <div class="album-art-col"><img class="album-art" src="${data.art}" alt="${name} album art"></div>
            <div class="playlist-col">
              <header class="playlist-head">
                <h3>${name}</h3>
                <button class="icon-btn play-all" title="Play all in ${name}">
                  <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                    <path d="M5 7h8M5 12h14M5 17h10" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
                    <path d="M17 8v8l5-4z" fill="currentColor"/>
                  </svg>
                </button>
              </header>
              <ul class="track-list">${items}</ul>
            </div>
          </article>`;
      }).join('');
    }
    renderAlbums();

    // set durations
    albumsView.querySelectorAll('.track-row').forEach(li=>{
      const a = new Audio(); a.src = li.dataset.src; a.preload='metadata';
      a.addEventListener('loadedmetadata', ()=>{ li.querySelector('.t-time').textContent = formatTime(a.duration); });
    });

    /* ---------- PLAYER ---------- */
    let scope='album', queue=[], index=0;
    const allQueue = albums.flatMap(([n,d]) => d.tracks.map(t=>t));

    function setAlbumQueue(name){
      scope='album'; queue = albumsMap[name].tracks.slice(); index=0;
      document.querySelectorAll('.album-row').forEach(r=> r.classList.toggle('active', r.dataset.album===name));
    }

    function loadTrackBySrc(src){
      index = queue.findIndex(t => t.src===src); if (index<0) index=0;
      const t = queue[index];
      audio.preload = 'auto';
      audio.src = t.src;
      audio.load();

      nowArt.src = albumsMap[t.album].art;
      nowTitle.textContent = t.title;
      nowAlbum.textContent = t.album;
      stageArt.src = albumsMap[t.album].art;
      stageTitle.textContent = t.title;
      stageAlbum.textContent = t.album;
      
      setTimeout(()=> dominantToStage(stageArt, trackStage), 0);

      document.querySelectorAll('.track-row').forEach(r=> r.classList.toggle('active', r.dataset.src===t.src));
    }

    // PLAY / PAUSE — solid toggle with proper state management
    function setPlayState(isPlaying){
      iconPlay.hidden  = isPlaying;
      iconPause.hidden = !isPlaying;
      playBtn.setAttribute('aria-pressed', String(isPlaying));
    }
    function play(){ audio.play().catch(()=>{}); setPlayState(true); }
    function pause(){ audio.pause(); setPlayState(false); }

    playBtn.addEventListener('click', ()=> audio.paused ? play() : pause());
    
    // Audio event listeners for proper state sync
    audio.addEventListener('play', ()=> setPlayState(true));
    audio.addEventListener('playing', ()=> setPlayState(true));
    audio.addEventListener('pause', ()=> setPlayState(false));
    audio.addEventListener('ended', ()=> setPlayState(false));

    function next(auto=false){
      index = (index+1) % queue.length;
      loadTrackBySrc(queue[index].src);
      if (auto) { overlaySuppressed=false; startAurora(true); }
      play();
    }
    function prev(){
      index = (index-1+queue.length) % queue.length;
      loadTrackBySrc(queue[index].src);
      play();
    }

    albumsView.addEventListener('click', e=>{
      const row = e.target.closest('.track-row');
      const playAll = e.target.closest('.play-all');
      const albumRow = e.target.closest('.album-row');

      if (playAll && albumRow){
        setAlbumQueue(albumRow.dataset.album);
        loadTrackBySrc(queue[0].src);
        play();
        scheduleShow();
        return;
      }
      if (row){
        if (scope!=='album' || queue.length===0 || (queue[0].album !== row.dataset.album)){
          setAlbumQueue(row.dataset.album);
        }
        loadTrackBySrc(row.dataset.src);
        play();
        scheduleShow();
      }
    });

    playAllBtn.addEventListener('click', ()=>{
      scope='all'; queue = allQueue.slice(); index=0;
      document.querySelectorAll('.album-row').forEach(r=> r.classList.remove('active'));
      loadTrackBySrc(queue[0].src); play(); scheduleShow();
      playAllBtn.classList.add('active'); setTimeout(()=> playAllBtn.classList.remove('active'), 220);
    });

    nextBtn.addEventListener('click', ()=> next(false));
    prevBtn.addEventListener('click', prev);

    // progress
    audio.addEventListener('timeupdate', ()=>{
      if (!isFinite(audio.duration)) return;
      seek.value = Math.floor(1000 * audio.currentTime / audio.duration);
      neon.style.setProperty('--pct', (audio.currentTime / audio.duration) * 100);
      currTime.textContent = formatTime(audio.currentTime);
      durTime.textContent  = formatTime(audio.duration);
    });
    seek.addEventListener('input', ()=>{
      if (isFinite(audio.duration)){
        audio.currentTime = (seek.value/1000) * audio.duration;
      }
    });
    audio.addEventListener('ended', ()=> { stopAurora(); next(true); });

    // modes
    function setMode(list){
      const isList = !!list;
      albumsView.classList.toggle('hidden', !isList);
      trackView.classList.toggle('hidden', isList);
      lightList.classList.toggle('on', isList);
      lightTrack.classList.toggle('on', !isList);
      shell.classList.toggle('track-bg', !isList);
      viewsWrap.classList.toggle('no-scroll', !isList);
      viewsWrap.scrollTop = 0;
    }
    lightList.addEventListener('click', ()=> setMode(true));
    lightTrack.addEventListener('click', ()=> setMode(false));

    // ---------- Dominant color for track mode bg
    function dominantToStage(img, host){
      const c=document.createElement('canvas'), ctx=c.getContext('2d',{willReadFrequently:true});
      const w=48,h=48; c.width=w; c.height=h;
      try{
        ctx.drawImage(img,0,0,w,h);
        const data=ctx.getImageData(0,0,w,h).data;
        const bins=new Map();
        for(let i=0;i<data.length;i+=4){
          const r=data[i],g=data[i+1],b=data[i+2],a=data[i+3];
          if(a<200) continue;
          const max=Math.max(r,g,b), min=Math.min(r,g,b);
          if(max<40 || (max-min)<12) continue;
          const key=(r>>4)+','+(g>>4)+','+(b>>4);
          bins.set(key,(bins.get(key)||0)+1);
        }
        let best=null,count=0;
        bins.forEach((v,k)=>{ if(v>count){count=v;best=k;} });
        if(best){
          const [R,G,B]=best.split(',').map(n=>parseInt(n,10)*16+8);
          host.style.setProperty('--stage-bg', `radial-gradient(120% 140% at 50% 25%, rgba(${R},${G},${B},.28), rgba(0,0,0,.9))`);
        }
      }catch(e){}
    }

    /* ---------- AURORA: ghostly fire with enhanced colors, seamless 10-min loop ---------- */
    const auroraCanvas = document.getElementById('aurora');
    const ctx = auroraCanvas.getContext('2d');
    const auroraLayer = document.querySelector('.aurora-layer');

    let acx, srcNode, analyser;
    let rafId=null, showTimer=null, hoverTimer=null, silenceTimer=null;
    let overlayOn=false, overlaySuppressed=false;

    function ensureAudioGraph(){
      if (acx) return;
      acx = new (window.AudioContext || window.webkitAudioContext)();
      srcNode = acx.createMediaElementSource(audio);
      analyser = acx.createAnalyser();
      analyser.fftSize = 2048;
      analyser.smoothingTimeConstant = 0.88; // reactive, not jittery
      srcNode.connect(analyser); analyser.connect(acx.destination);
    }

    function sizeCanvas(){
      const r = auroraLayer.getBoundingClientRect();
      auroraCanvas.width  = Math.max(1, r.width|0);
      auroraCanvas.height = Math.max(1, r.height|0);
    }
    sizeCanvas(); addEventListener('resize', sizeCanvas);

    const LOOP_S = 600;               // 10 minutes
    const PHASE_MS = 48000;           // color phase length (smooth)
    let loopStart = performance.now();
    let phaseStart = performance.now();

    let gradA = makePhase();
    let gradB = makePhase();

    function makePhase(){
      return {
        seed: Math.random()*360,
        n: chooseCount(), // 3..7, mostly 3-5
        tilt: (Math.random()*6-3) * Math.PI/180 // near-vertical
      };
    }
    function chooseCount(){
      const r = Math.random();
      if (r < 0.55) return 4;
      if (r < 0.85) return 3;
      if (r < 0.95) return 5;
      return Math.random()<0.5 ? 6 : 7;
    }

    function startAurora(immediate=false){ 
      if(overlayOn) return; 
      overlayOn=true; overlaySuppressed=false;
      auroraLayer.classList.add('on');
      ensureAudioGraph(); 
      draw(); 
    }
    function stopAurora(){ 
      overlayOn=false; 
      auroraLayer.classList.remove('on');
      if(rafId){cancelAnimationFrame(rafId); rafId=null;} 
    }
    function scheduleShow(){
      if (overlayOn || overlaySuppressed) return;
      clearTimeout(showTimer);
      showTimer = setTimeout(()=>{ if (!audio.paused) startAurora(false); }, 20000);
    }

    // hover 5s → hide
    shell.addEventListener('mouseenter', ()=>{
      if (!overlayOn) return;
      clearTimeout(hoverTimer);
      hoverTimer = setTimeout(()=>{ overlaySuppressed=true; stopAurora(); }, 5000);
    });
    shell.addEventListener('mouseleave', ()=>{
      clearTimeout(hoverTimer);
      if (!audio.paused){ overlaySuppressed=false; scheduleShow(); }
    });

    audio.addEventListener('play', ()=>{ ensureAudioGraph(); scheduleShow(); });
    audio.addEventListener('pause', ()=>{ clearTimeout(showTimer); stopAurora(); });

    function checkSilence(){
      if (!analyser) return;
      const buf = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(buf);
      let sum=0; for (let i=0;i<buf.length;i++) sum+=buf[i];
      const avg = sum / buf.length;
      if (avg < 5){ if (!silenceTimer) silenceTimer = setTimeout(stopAurora, 2000); }
      else { clearTimeout(silenceTimer); silenceTimer=null; }
      return { avg, buf };
    }

    function gradientVertical(phase, t, w, h){
      // vertical backbone with tiny drift
      const drift = Math.sin(t/10000) * (8*Math.PI/180);
      const ang = phase.tilt + drift;

      // build vertical/tilted gradient
      const R = Math.hypot(w,h);
      const cx=w/2, cy=h*0.65;
      const x0=cx - Math.cos(ang)*R/2, y0=cy - Math.sin(ang)*R/2;
      const x1=cx + Math.cos(ang)*R/2, y1=cy + Math.sin(ang)*R/2;

      const g = ctx.createLinearGradient(x0,y0,x1,y1);
      const n = phase.n;
      for(let i=0;i<n;i++){
        const f = i/(n-1||1);
        // Enhanced color palette - deeper, richer hues without harsh whites
        const hue = (phase.seed + i*(360/n) + 40*Math.sin((t/LOOP_S + i*0.13))) % 360;
        g.addColorStop(f, `hsla(${hue} 85% 45% / 0.75)`);
        if (i<n-1){
          const mid = f + (1/(n-1))*0.45;
          const hue2 = (hue + 18) % 360;
          g.addColorStop(mid, `hsla(${hue2} 80% 48% / 0.65)`);
        }
      }
      return g;
    }

    // Ghostly stacked "curtains" from bottom → ethereal fire look
    function drawCurtains(time, energy, w, h){
      const steps=180;
      const base = h*0.08;
      const maxRise = h*0.45; // slightly lower for ghostly effect
      const kx = 2*Math.PI/Math.max(420,w);
      const ph = ((time - loopStart)/1000) * 1.1;

      // 4 stacked layers for more ethereal depth
      for(let layer=0; layer<4; layer++){
        const att = [0.9, 0.7, 0.5, 0.3][layer]; // more transparent layers
        ctx.beginPath();
        ctx.moveTo(0,h);
        for(let i=0;i<=steps;i++){
          const x=(i/steps)*w;

          // multi-sine height field with more ethereal movement
          const yWave =
            Math.sin(kx*x + ph*1.00 + layer*0.6) * (0.65) +
            Math.sin(kx*1.7*x + ph*1.35 + layer*0.8) * (0.42) +
            Math.sin(kx*3.2*x + ph*0.95 + layer*1.1) * (0.28) +
            Math.sin(kx*5.1*x + ph*0.7 + layer*1.4) * (0.15);

          // vertical curtain modulation - more fluid
          const curtain = 0.75 + 0.65*Math.sin(x*kx*0.5 + layer*0.7 + ph*0.3);

          let rise = (h*(0.18 + 0.52*energy) * (0.45 + 0.55*yWave) * curtain) * att;
          rise = Math.min(rise, maxRise);

          const y = h - (base + rise);
          ctx.lineTo(x,y);
        }
        ctx.lineTo(w,h); ctx.closePath();
        ctx.fill();
      }

      // Enhanced fade for ghostly top
      const fade = ctx.createLinearGradient(0, 0, 0, h);
      fade.addColorStop(0.00, 'rgba(0,0,0,0.95)'); // stronger fade at top
      fade.addColorStop(0.25, 'rgba(0,0,0,0.4)');
      fade.addColorStop(0.45, 'rgba(0,0,0,0)');
      ctx.globalCompositeOperation='destination-out';
      ctx.fillStyle=fade; ctx.fillRect(0,0,w,h);
      ctx.globalCompositeOperation='screen';
    }

    function getBands(arr){
      // approximate Hz mapping for better audio reactivity
      const nyq = acx.sampleRate/2;
      const idx = hz => Math.min(arr.length-1, Math.max(0, Math.round(arr.length*(hz/nyq))));
      const avg = (lo,hi) => {
        let s=0,c=0; for (let i=lo;i<=hi;i++){ s+=arr[i]; c++; } return c? s/c : 0;
      };
      return {
        bass: avg(idx(20), idx(150)),
        mid:  avg(idx(400), idx(2000)),
        treb: avg(idx(4000), idx(12000))
      };
    }

    function draw(){
      if(!overlayOn) return;
      rafId=requestAnimationFrame(draw);
      sizeCanvas();

      const w=auroraCanvas.width, h=auroraCanvas.height;
      const now = performance.now();

      ctx.clearRect(0,0,w,h);

      // audio analysis
      const { buf } = checkSilence() || {};
      const bands = buf ? getBands(buf) : {bass:0, mid:0, treb:0};

      // Enhanced energy calculation for ghostly effect
      const energy = Math.min(1, 0.5*bands.bass/255 + 0.35*bands.mid/255 + 0.15*bands.treb/255);

      // color phase crossfade
      let mix = (now - phaseStart) / PHASE_MS;
      if (mix >= 1){
        gradA = gradB; gradB = makePhase(); phaseStart = now; mix = 0;
      }

      const gA = gradientVertical(gradA, now/1000, w, h);
      const gB = gradientVertical(gradB, now/1000, w, h);

      // Enhanced blending for ghostly effect
      ctx.globalCompositeOperation='source-over';
      ctx.fillStyle = gA; ctx.globalAlpha = (1 - mix) * 0.85; ctx.fillRect(0,0,w,h);
      ctx.fillStyle = gB; ctx.globalAlpha = mix * 0.85;     ctx.fillRect(0,0,w,h);
      ctx.globalAlpha = 1;

      // Multiple blur passes for ethereal glow without harsh whites
      ctx.save();
      ctx.filter = 'blur(8px)'; 
      ctx.globalAlpha = 0.6;
      ctx.globalCompositeOperation = 'screen';
      ctx.fillStyle = gA; ctx.fillRect(0,0,w,h);
      ctx.globalAlpha = mix * 0.6; 
      ctx.fillStyle = gB; ctx.fillRect(0,0,w,h);
      
      // Additional soft blur layer
      ctx.filter = 'blur(16px)'; 
      ctx.globalAlpha = 0.3;
      ctx.fillStyle = gA; ctx.fillRect(0,0,w,h);
      ctx.globalAlpha = mix * 0.3; 
      ctx.fillStyle = gB; ctx.fillRect(0,0,w,h);
      
      ctx.restore();

      // mask to ghostly fire shape
      ctx.save();
      ctx.globalCompositeOperation='destination-in';
      ctx.fillStyle = '#000'; // mask shape
      drawCurtains(now, energy, w, h);
      ctx.restore();
    }

    // boot
    setAlbumQueue(Object.keys(albumsMap)[0]);
    loadTrackBySrc(albumsMap[Object.keys(albumsMap)[0]].tracks[0].src);
    setMode(true);
    setPlayState(false); // show Play icon initially
  })();

  function formatTime(t){ const m=Math.floor(t/60); const s=Math.floor(t%60).toString().padStart(2,'0'); return `${m}:${s}`; }
  </script>
</section>

</body>
</html>