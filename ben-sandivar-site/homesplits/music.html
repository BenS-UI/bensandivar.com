<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Music Player</title>

  <style>
  /* ======================== YOUR CSS ======================== */

  /* utils */
  [hidden]{display:none!important;}
  .hidden{display:none!important;}

  /* FORCE NORMAL FLOW — keep this section under the hero */
  section.bucket-hero{ position:relative; z-index:2; }
  #music.music-player{
    position:relative !important;
    z-index:1 !important;
    inset:auto !important;
    clear:both;
    display:flow-root;
    contain: layout paint;
  }

  .music-player{
    margin-top: clamp(24px, 8vh, 120px);
    margin-bottom: 10vh;
    padding: 0 8vw;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .music-shell{
    isolation:isolate;
    width:100%;
    margin:0 auto;
    border-radius:28px;
    position:relative;
    background: radial-gradient(120% 120% at 60% 20%, rgba(255,255,255,.04), rgba(0,0,0,.45));
    border:1px solid rgba(255,255,255,.08);
    box-shadow: 0 8px 22px rgba(0,0,0,.22);
    display:flex;
    flex-direction:column;
    height: clamp(560px, 72vh, 860px);
    padding:2.25rem 2rem 1.25rem;
    overflow:hidden;
  }
  @media (min-width:1024px){ .music-shell{ width:75%; } }

  .page-header{ text-align:center; margin-bottom: 2rem; }

  /* VIEW SWITCH */
  .mode-lights{ position:absolute; top:.6rem; left:50%; transform:translateX(-50%); display:flex; gap:.5rem; align-items:center; z-index:6; }
  .mode-lights .light{
    width:12px; height:12px; border-radius:999px; border:0; cursor:pointer;
    background: radial-gradient(circle at 35% 35%, #7ab8ff 10%, #1f6fff 70%, #0036e8 100%);
    box-shadow: 0 0 10px rgba(47,132,255,.9), 0 0 18px rgba(47,132,255,.5);
    opacity:.65; transition:opacity .2s ease, transform .08s ease;
  }
  .mode-lights .light.on{ opacity:1; }
  .mode-lights .light:active{ transform:scale(.92); }
  .mode-lights .hint{
    position:absolute; top:1.6rem; left:50%; transform:translateX(-50%);
    padding:.35rem .6rem; font-size:.72rem; border-radius:10px;
    background: rgba(255,255,255,.12); color: var(--color-primary);
    border:1px solid rgba(255,255,255,.18); backdrop-filter: blur(6px);
    opacity:0; pointer-events:none; transition:opacity .2s ease;
  }
  .mode-lights:hover .hint{ opacity:1; }

  /* LAYERS (z-index order) */
  .views-wrap{ flex:1; overflow:auto; padding-top:.25rem; position:relative; z-index:1; }
  .views-wrap.no-scroll{ overflow:hidden; }

  /* aurora behind album art, above list */
  .aurora-layer{
    position:absolute;
    inset:0;
    z-index:2;
    pointer-events:none;
    border-radius:inherit;
    opacity:1;
  }
  .aurora-layer.on{ opacity:1; }
  .aurora-layer canvas{ width:100%; height:100%; display:block; }

  .track-stage .stage-art-wrap{ z-index:3; position:relative; }
  /* player bar at top of stack */
  .player-bar{ position:relative; z-index:4; }

  /* LIST VIEW */
  .albums-view{ display:grid; gap:1.75rem; }
  .album-row{
    display:grid; grid-template-columns:140px 1fr; gap:1rem;
    background: rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.08);
    border-radius:18px; padding:1rem;
  }
  @media (max-width:720px){ .album-row{ grid-template-columns:100px 1fr; } }
  .album-art{ width:120px; height:120px; border-radius:12px; object-fit:cover; box-shadow:0 8px 18px rgba(0,0,0,.28); }
  .playlist-col{ display:flex; flex-direction:column; gap:.6rem; }
  .playlist-head{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
  .playlist-head h3{ margin:0; font-size:1.1rem; }
  .icon-btn.play-all{
    width:34px; height:34px; border-radius:10px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color: var(--color-primary);
    backdrop-filter: blur(6px);
  }
  .track-list{ list-style:none; margin:0; padding:0; display:grid; gap:.3rem; }
  .track-row{
    display:grid; grid-template-columns:1fr auto; align-items:center;
    padding:.45rem .6rem; border-radius:10px; transition:background .2s ease;
  }
  .track-row:hover{ background: rgba(255,255,255,.05); }
  .track-row.active .t-title{ font-weight:700; }
  .t-title{ text-align:left; }
  .t-time{ text-align:right; opacity:.82; min-width:3.2rem; }

  /* TRACK VIEW (art only) */
  .music-shell.track-bg{
    background: var(--stage-bg, radial-gradient(120% 140% at 50% 25%, rgba(0,0,0,.36), rgba(0,0,0,.9)));
  }
  .track-view{ border-radius:22px; padding:2rem 1.25rem; }
  .track-stage{ display:grid; justify-items:center; z-index:3; position:relative; }
  .stage-art-wrap{
    width:min(42%, 440px); aspect-ratio:1/1; border-radius:18px;
    box-shadow:0 14px 32px rgba(0,0,0,.32);
  }
  #stage-art{ width:100%; height:100%; object-fit:cover; border-radius:18px; display:block; }

  /* PLAYER BAR */
  .player-bar{
    margin-top:1rem;
    display:grid; grid-template-columns:auto 1fr; gap:1rem; align-items:center;
    padding:.85rem 1rem; border-radius:16px; border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06); backdrop-filter: blur(10px);
  }
  @media (min-width:760px){ .player-bar{ grid-template-columns:auto auto 1fr; } }

  .now{ display:grid; grid-template-columns:auto 1fr; gap:.6rem; align-items:center; }
  .now-art{ width:40px; height:40px; border-radius:8px; object-fit:cover; box-shadow:0 4px 12px rgba(0,0,0,.25); }
  .now-meta{ display:flex; flex-direction:column; line-height:1.1; }
  .now-meta small{ opacity:.75; }

  .controls{ display:flex; gap:.5rem; align-items:center; }
  .icon-btn{
    display:grid; place-items:center; width:36px; height:36px; border-radius:12px;
    border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); color: var(--color-primary);
    transition: box-shadow .2s ease, border-color .2s ease, transform .06s ease;
  }
  .icon-btn:hover{ border-color: rgba(0,110,255,.5); box-shadow: 0 0 12px rgba(47,132,255,.35); }
  .icon-btn:active{ transform:scale(.97); }
  .icon-btn.primary{ width:42px; height:42px; color:#fff; background: rgba(0,110,255,.18); border-color: rgba(0,110,255,.55); }
  .icon-btn.active{ box-shadow: 0 0 16px rgba(47,132,255,.6); }

  /* Progress */
  .progress{ display:grid; grid-template-columns:auto 1fr auto; gap:.6rem; align-items:center; }
  .time{ font-variant-numeric: tabular-nums; opacity:.85; min-width:3ch; text-align:right; }
  .bar{ position:relative; height:18px; display:flex; align-items:center; }
  .bar-track{ position:absolute; left:0; right:0; height:8px; border-radius:999px; background: rgba(255,255,255,.18); }
  .neon{
    --pct:0;
    position:absolute; left:0; height:6px; width: calc(var(--pct) * 1%); border-radius:999px;
    background: linear-gradient(90deg, #0a5bff, #2f84ff);
    box-shadow: 0 0 18px #2f84ff, 0 0 36px rgba(47,132,255,.5);
  }
  #seek{
    -webkit-appearance:none; appearance:none; width:100%; height:18px; margin:0; background:transparent; position:relative; z-index:1;
  }
  #seek::-webkit-slider-runnable-track{ height:18px; background:transparent; }
  #seek::-moz-range-track{ height:18px; background:transparent; }
  #seek::-webkit-slider-thumb{
    -webkit-appearance:none; width:16px; height:16px; border-radius:50%; margin-top:1px;
    background:#fff; border:1px solid rgba(47,132,255,.95); box-shadow:0 0 12px rgba(47,132,255,.9);
  }
  #seek::-moz-range-thumb{
    width:16px; height:16px; border-radius:50%;
    background:#fff; border:1px solid rgba(47,132,255,.95); box-shadow:0 0 12px rgba(47,132,255,.9);
  }

  /* Dark theme ready */
  body[data-theme="dark"] .music-shell{
    background: radial-gradient(120% 120% at 60% 20%, rgba(255,255,255,.02), rgba(0,0,0,.78));
    border-color: rgba(255,255,255,.07);
  }
  body[data-theme="dark"] .album-row{ background: rgba(255,255,255,.04); border-color: rgba(255,255,255,.08); }
  body[data-theme="dark"] .player-bar{ background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.12); }
  body[data-theme="dark"] .icon-btn{ background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.14); }

  /* ===== Play/Pause icon toggle (add to your stylesheet if you prefer) ===== */
  .toggle-icon{ display:none; }
  .toggle-icon.active{ display:inline; }
  </style>
</head>
<body>

<section id="music" class="music-player fade-in" data-split="music">
  <div class="page-header">
    <h2>Music</h2>
    <p>Albums and tracks in a simple player.</p>
  </div>

  <div class="music-shell">
    <!-- view switch -->
    <div class="mode-lights" role="group" aria-label="View switch">
      <button id="light-list" class="light on" aria-label="List view"></button>
      <button id="light-track" class="light" aria-label="Track view"></button>
      <div class="hint" role="note">Tap a dot to switch views</div>
    </div>

    <!-- content -->
    <div class="views-wrap" id="viewsWrap">
      <div id="albums-view" class="albums-view" aria-live="polite"></div>

      <!-- Track view: art only -->
      <div id="track-view" class="track-view hidden">
        <div class="track-stage">
          <div class="stage-art-wrap">
            <img id="stage-art" src="" alt="Album art">
          </div>
        </div>
      </div>
    </div>

    <!-- AURORA (over list, under track art + player) -->
    <div class="aurora-layer" aria-hidden="true">
      <canvas id="aurora"></canvas>
    </div>

    <!-- player bar -->
    <div class="player-bar glass">
      <div class="now">
        <img id="nowArt" src="" alt="" class="now-art">
        <div class="now-meta">
          <span id="nowTitle">—</span>
          <small id="nowAlbum">—</small>
        </div>
      </div>

      <div class="controls">
        <button class="icon-btn" id="playAllBtn" title="Play entire library">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
            <path d="M5 7h8M5 12h14M5 17h10" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
            <path d="M17 8v8l5-4z" fill="currentColor"/>
          </svg>
        </button>

        <button class="icon-btn" id="prevBtn" title="Previous">
          <svg viewBox="0 0 24 24" width="18" height="18"><path d="M6 6v12M18 6l-8 6 8 6V6z" fill="currentColor"/></svg>
        </button>

        <!-- PLAY/PAUSE (class-based icon toggles) -->
        <button class="icon-btn primary" id="playPauseBtn" title="Play / Pause" aria-pressed="false">
          <svg id="iconPlay" class="toggle-icon active" viewBox="0 0 24 24" width="20" height="20">
            <path d="M8 5v14l11-7z" fill="currentColor"/></svg>
          <svg id="iconPause" class="toggle-icon" viewBox="0 0 24 24" width="20" height="20">
            <path d="M7 5h4v14H7zM13 5h4v14h-4z" fill="currentColor"/></svg>
        </button>

        <button class="icon-btn" id="nextBtn" title="Next">
          <svg viewBox="0 0 24 24" width="18" height="18"><path d="M18 6v12M6 6l8 6-8 6V6z" fill="currentColor"/></svg>
        </button>
      </div>

      <div class="progress">
        <span id="currTime" class="time">0:00</span>
        <div class="bar">
          <div class="bar-track"></div>
          <div class="neon"></div>
          <input id="seek" type="range" min="0" max="1000" value="0" step="1" aria-label="Seek">
        </div>
        <span id="durTime" class="time">0:00</span>
      </div>

      <audio id="audio" preload="metadata" crossorigin="anonymous"></audio>
    </div>
  </div>

  <!-- Player logic -->
  <script>
  (function(){
    const tracks = [
      { title:"Rain",        src:"assets/tracks/Track 1.mp3", album:"Musings",              art:"assets/tracks/Musings.jpg" },
      { title:"Sonata",      src:"assets/tracks/Track 2.mp3", album:"Musings",              art:"assets/tracks/Musings.jpg" },
      { title:"Münchhausen", src:"assets/tracks/Track 3.mp3", album:"Musings",              art:"assets/tracks/Musings.jpg" },
      { title:"Growing Old", src:"assets/tracks/Track 4.mp3", album:"Musings",              art:"assets/tracks/Musings.jpg" },
      { title:"The Adventure Begins", src:"assets/tracks/Track 5.mp3", album:"The Adventure Begins", art:"assets/tracks/Adventure.jpg" }
    ];

    const albumsMap = {};
    tracks.forEach(t => {
      if (!albumsMap[t.album]) albumsMap[t.album] = { art:t.art, tracks:[] };
      albumsMap[t.album].tracks.push(t);
    });

    const shell      = document.querySelector('.music-shell');
    const viewsWrap  = document.getElementById('viewsWrap');
    const albumsView = document.getElementById('albums-view');
    const trackView  = document.getElementById('track-view');
    const lightList  = document.getElementById('light-list');
    const lightTrack = document.getElementById('light-track');

    const audio   = document.getElementById('audio');
    const playBtn = document.getElementById('playPauseBtn');
    const iconPlay  = document.getElementById('iconPlay');
    const iconPause = document.getElementById('iconPause');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const playAllBtn = document.getElementById('playAllBtn');
    const seek   = document.getElementById('seek');
    const currTime = document.getElementById('currTime');
    const durTime  = document.getElementById('durTime');
    const nowArt   = document.getElementById('nowArt');
    const nowTitle = document.getElementById('nowTitle');
    const nowAlbum = document.getElementById('nowAlbum');
    const stageArt = document.getElementById('stage-art');

    function renderAlbums(){
      albumsView.innerHTML = Object.entries(albumsMap)
        .sort((a,b)=> b[1].tracks.length - a[1].tracks.length)
        .map(([name, data])=>{
          const items = data.tracks.map(t => `
            <li class="track-row" data-src="\${t.src}" data-title="\${t.title}" data-album="${name}" data-art="${data.art}">
              <span class="t-title">\${t.title}</span>
              <span class="t-time">--:--</span>
            </li>`).join('');
          return `
            <article class="album-row" data-album="${name}">
              <div class="album-art-col"><img class="album-art" src="${data.art}" alt="${name} album art"></div>
              <div class="playlist-col">
                <header class="playlist-head">
                  <h3>${name}</h3>
                  <button class="icon-btn play-all" title="Play all in ${name}">
                    <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                      <path d="M5 7h8M5 12h14M5 17h10" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <path d="M17 8v8l5-4z" fill="currentColor"/>
                    </svg>
                  </button>
                </header>
                <ul class="track-list">${items}</ul>
              </div>
            </article>`;
        }).join('');
    }
    renderAlbums();

    // Populate durations
    albumsView.querySelectorAll('.track-row').forEach(li=>{
      const a = new Audio(); a.src = li.dataset.src; a.preload='metadata';
      a.addEventListener('loadedmetadata', ()=>{ li.querySelector('.t-time').textContent = formatTime(a.duration); });
    });

    let scope='album', queue=[], index=0;
    const allQueue = Object.entries(albumsMap).flatMap(([n,d]) => d.tracks);

    function setAlbumQueue(name){
      scope='album'; queue = albumsMap[name].tracks.slice(); index=0;
      document.querySelectorAll('.album-row').forEach(r=> r.classList.toggle('active', r.dataset.album===name));
    }

    function loadTrackBySrc(src){
      index = queue.findIndex(t => t.src===src); if (index<0) index=0;
      const t = queue[index];
      audio.preload = 'auto';
      audio.src = t.src;
      audio.load();

      nowArt.src = albumsMap[t.album].art;
      nowTitle.textContent = t.title;
      nowAlbum.textContent = t.album;
      stageArt.src = albumsMap[t.album].art;

      document.querySelectorAll('.track-row').forEach(r=> r.classList.toggle('active', r.dataset.src===t.src));
    }

    // --- ICON STATE (class-based) ---
    function refreshPlayState() {
      const isPlaying = !audio.paused && !audio.ended && audio.readyState >= 2;
      iconPlay.classList.toggle('active', !isPlaying);
      iconPause.classList.toggle('active', isPlaying);
      playBtn.setAttribute('aria-pressed', String(isPlaying));
    }

    // --- CONTROL HELPERS ---
    async function play() {
      try { await audio.play(); } catch {}
      refreshPlayState();
    }
    function pause() {
      audio.pause();
      refreshPlayState();
    }

    // --- BUTTON ---
    playBtn.addEventListener('click', () => (audio.paused ? play() : pause()));

    // --- EVENTS: always recheck state ---
    [
      'play','playing','pause','ended',
      'timeupdate','seeking','seeked','ratechange',
      'loadeddata','canplay','waiting','stalled','suspend','emptied','abort'
    ].forEach(ev => audio.addEventListener(ev, refreshPlayState));

    function next(auto=false){
      index = (index+1) % queue.length;
      loadTrackBySrc(queue[index].src);
      if (auto) window.aurora?.instant?.();
      play();
    }
    function prev(){
      index = (index-1+queue.length) % queue.length;
      loadTrackBySrc(queue[index].src);
      play();
    }

    // List actions
    albumsView.addEventListener('click', e=>{
      const row = e.target.closest('.track-row');
      const playAll = e.target.closest('.play-all');
      const albumRow = e.target.closest('.album-row');

      if (playAll && albumRow){
        setAlbumQueue(albumRow.dataset.album);
        loadTrackBySrc(queue[0].src);
        play();
        return;
      }
      if (row){
        if (scope!=='album' || queue.length===0 || (queue[0].album !== row.dataset.album)){
          setAlbumQueue(row.dataset.album);
        }
        loadTrackBySrc(row.dataset.src);
        play();
      }
    });

    // Global play-all
    playAllBtn.addEventListener('click', ()=>{
      scope='all'; queue = allQueue.slice(); index=0;
      document.querySelectorAll('.album-row').forEach(r=> r.classList.remove('active'));
      loadTrackBySrc(queue[0].src); play();
      playAllBtn.classList.add('active'); setTimeout(()=> playAllBtn.classList.remove('active'), 240);
    });

    nextBtn.addEventListener('click', ()=> next(false));
    prevBtn.addEventListener('click', prev);

    // Progress
    audio.addEventListener('timeupdate', ()=>{
      if (!isFinite(audio.duration)) return;
      seek.value = Math.floor(1000 * audio.currentTime / audio.duration);
      document.querySelector('.bar .neon').style.setProperty('--pct', (audio.currentTime / audio.duration) * 100);
      currTime.textContent = formatTime(audio.currentTime);
      durTime.textContent  = formatTime(audio.duration);
    });
    seek.addEventListener('input', ()=>{
      if (isFinite(audio.duration)){
        audio.currentTime = (seek.value/1000) * audio.duration;
      }
    });
    audio.addEventListener('ended', ()=> next(true));

    function setMode(list){
      const isList = !!list;
      albumsView.classList.toggle('hidden', !isList);
      trackView.classList.toggle('hidden', isList);
      lightList.classList.toggle('on', isList);
      lightTrack.classList.toggle('on', !isList);
      shell.classList.toggle('track-bg', !isList);
      viewsWrap.classList.toggle('no-scroll', !isList);
      viewsWrap.scrollTop = 0;
    }
    lightList.addEventListener('click', ()=> setMode(true));
    lightTrack.addEventListener('click', ()=> setMode(false));

    function formatTime(t){
      const m=Math.floor(t/60);
      const s=Math.floor(t%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    }

    // Initial view + first track
    setMode(true);
    refreshPlayState();
    const firstAlbum = Object.keys(albumsMap)[0];
    if (firstAlbum){
      const q = albumsMap[firstAlbum].tracks;
      if (q && q.length){ loadTrackBySrc(q[0].src); }
    }
  })();
  </script>

  <!-- Aurora visualizer -->
  <script src="./aurora.js"></script>
</section>

</body>
</html>
