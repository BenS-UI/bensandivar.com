<section id="music" class="music-player fade-in" data-split="music">
  <div class="page-header">
    <h2>Music</h2>
    <p>Some of the music I make</p>
  </div>

  <div class="music-shell">
    <!-- view switch -->
    <div class="mode-lights" role="group" aria-label="View switch">
      <button id="light-list" class="light on" aria-label="List view"></button>
      <button id="light-track" class="light" aria-label="Track view"></button>
      <div class="hint" role="note">Switch views</div>
    </div>

    <!-- content -->
    <div class="views-wrap" id="viewsWrap">
      <div id="albums-view" class="albums-view" aria-live="polite"></div>

      <!-- Track view: art only -->
      <div id="track-view" class="track-view hidden">
        <div class="track-stage">
          <div class="stage-art-wrap" id="stageArtWrap">
            <img id="stage-art" src="" alt="Album art">
          </div>
        </div>
      </div>
    </div>

    <!-- AURORA (over list, under track art + player) -->
    <div class="aurora-layer" aria-hidden="true">
      <canvas id="aurora"></canvas>
    </div>

    <!-- player bar (split 50/50) -->
    <div class="player-bar glass compact">
      <div class="player-left">
        <div class="now">
          <img id="nowArt" src="" alt="" class="now-art">
          <div class="now-meta">
            <span id="nowTitle" title="—">—</span>
            <small id="nowAlbum" title="—">—</small>
          </div>
        </div>

        <!-- Controls stay right-aligned inside left half -->
        <div class="controls" aria-label="Playback controls">
          <!-- Scope toggle: shows the ACTION you’ll switch to -->
          <button class="icon-btn" id="toggleScopeBtn" title="Switch to play 1 track">
            <!-- ALL-library action (Iconify) -->
            <img class="toggle-icon remote-icon scope-all"
                 src="https://api.iconify.design/mdi/playlist-play.svg"
                 width="20" height="20" alt="" />
            <!-- “Play one” (inline, follows currentColor) -->
            <svg class="toggle-icon scope-one active" xmlns="http://www.w3.org/2000/svg"
                 width="20" height="20" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <path d="M3 5h10"/>
              <path d="M3 9h10"/>
              <path d="M3 13h6"/>
              <path d="M21 15l-6 6"/>
              <path d="M15 15l6 6"/>
            </svg>
          </button>

          <button class="icon-btn" id="prevBtn" title="Previous">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path d="M6 6v12M18 6l-8 6 8 6V6z" fill="currentColor"/></svg>
          </button>

          <!-- PLAY/PAUSE (class-based icon toggles) -->
          <button class="icon-btn primary" id="playPauseBtn" title="Play / Pause" aria-pressed="false">
            <svg id="iconPlay" class="toggle-icon active" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
              <path d="M8 5v14l11-7z" fill="currentColor"/>
            </svg>
            <svg id="iconPause" class="toggle-icon" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
              <path d="M7 5h4v14H7zM13 5h4v14h-4z" fill="currentColor"/>
            </svg>
          </button>

          <button class="icon-btn" id="nextBtn" title="Next">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path d="M18 6v12M6 6l8 6-8 6V6z" fill="currentColor"/></svg>
          </button>

          <!-- Loop tri-state: off / all / one (Iconify) -->
          <button class="icon-btn" id="loopBtn" title="Loop off">
            <!-- off -->
            <img class="toggle-icon remote-icon loop-off active"
                 src="https://api.iconify.design/mdi/repeat-off.svg"
                 width="20" height="20" alt="" />
            <!-- all -->
            <img class="toggle-icon remote-icon loop-all"
                 src="https://api.iconify.design/mdi/repeat.svg"
                 width="20" height="20" alt="" />
            <!-- one -->
            <img class="toggle-icon remote-icon loop-one"
                 src="https://api.iconify.design/mdi/repeat-once.svg"
                 width="20" height="20" alt="" />
          </button>

          <!-- Shuffle toggle (Iconify) -->
          <button class="icon-btn" id="shuffleBtn" title="Shuffle off">
            <!-- on -->
            <img class="toggle-icon remote-icon shuffle-on"
                 src="https://api.iconify.design/mdi/shuffle.svg"
                 width="20" height="20" alt="" />
            <!-- off -->
            <img class="toggle-icon remote-icon shuffle-off active"
                 src="https://api.iconify.design/mdi/shuffle-disabled.svg"
                 width="20" height="20" alt="" />
          </button>
        </div>
      </div>

      <div class="player-right">
        <div class="progress">
          <span id="currTime" class="time">0:00</span>
          <div class="bar">
            <div class="bar-track"></div>
            <div class="neon"></div>
            <input id="seek" type="range" min="0" max="1000" value="0" step="1" aria-label="Seek">
          </div>
          <span id="durTime" class="time">0:00</span>
        </div>
      </div>

      <audio id="audio" preload="metadata" crossorigin="anonymous"></audio>
    </div>
  </div>

  <!-- Player logic -->
  <script>
  (function(){
    const tracks = [
      { title:"Rain",        src:"assets/tracks/Track 1.mp3", album:"Musings",              art:"assets/tracks/Musings.jpg" },
      { title:"Sonata",      src:"assets/tracks/Track 2.mp3", album:"Musings",              art:"assets/tracks/Musings.jpg" },
      { title:"Münchhausen", src:"assets/tracks/Track 3.mp3", album:"Musings",              art:"assets/tracks/Musings.jpg" },
      { title:"Growing Old", src:"assets/tracks/Track 4.mp3", album:"Musings",              art:"assets/tracks/Musings.jpg" },
      { title:"Musings",     src:"assets/tracks/Track 6.mp3", album:"Musings",              art:"assets/tracks/Musings.jpg" },
      { title:"The Adventure Begins", src:"assets/tracks/Track 5.mp3", album:"The Adventure Begins", art:"assets/tracks/Adventure.jpg" },
      { title:"On The Shortness of Life", src:"assets/tracks/Track 7.mp3", album:"The Myth of Rebirth", art:"assets/tracks/Myth.jpg" }
    ];

    const albumsMap = {};
    tracks.forEach(t => {
      if (!albumsMap[t.album]) albumsMap[t.album] = { art:t.art, tracks:[] };
      albumsMap[t.album].tracks.push(t);
    });

    const body       = document.body;
    const musicSection = document.getElementById('music');
    const shell      = document.querySelector('.music-shell');
    const viewsWrap  = document.getElementById('viewsWrap');
    const albumsView = document.getElementById('albums-view');
    const trackView  = document.getElementById('track-view');
    const lightList  = document.getElementById('light-list');
    const lightTrack = document.getElementById('light-track');

    const audio   = document.getElementById('audio');
    const playBtn = document.getElementById('playPauseBtn');
    const iconPlay  = document.getElementById('iconPlay');
    const iconPause = document.getElementById('iconPause');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    const toggleScopeBtn = document.getElementById('toggleScopeBtn');
    const loopBtn = document.getElementById('loopBtn');
    const shuffleBtn = document.getElementById('shuffleBtn');

    const seek   = document.getElementById('seek');
    const currTime = document.getElementById('currTime');
    const durTime  = document.getElementById('durTime');
    const nowArt   = document.getElementById('nowArt');
    const nowTitle = document.getElementById('nowTitle');
    const nowAlbum = document.getElementById('nowAlbum');
    const stageArt = document.getElementById('stage-art');
    const stageArtWrap = document.getElementById('stageArtWrap');

    // --- placeholder CD for player bar + stage BEFORE first selection ---
    function makeCDDataURL() {
      const svg =
        `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 160'>
           <defs>
             <radialGradient id='g' cx='50%' cy='50%' r='60%'>
               <stop offset='0%' stop-color='white' stop-opacity='1'/>
               <stop offset='100%' stop-color='white' stop-opacity='1'/>
             </radialGradient>
           </defs>
           <circle cx='80' cy='80' r='70' fill='url(#g)' />
           <circle cx='80' cy='80' r='14' fill='none' stroke='rgba(0,0,0,0.12)' stroke-width='3'/>
         </svg>`;
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    }
    const CD_PLACEHOLDER = makeCDDataURL();

    // start with no selection
    let hasSelection = false;
    nowArt.src = CD_PLACEHOLDER;
    nowArt.alt = 'No track selected';
    stageArt.removeAttribute('src'); // track view shows CD when toggled on (see setMode)

    // ---------- layout helpers ----------
    function setTooltip(el, text){ el.title = text || ''; }

    function renderAlbums(){
      albumsView.innerHTML = Object.entries(albumsMap)
        .sort((a,b)=> b[1].tracks.length - a[1].tracks.length)
        .map(([name, data])=>{
          const items = data.tracks.map(t => `
            <li class="track-row" data-src="${t.src}" data-title="${t.title}" data-album="${name}" data-art="${data.art}">
              <span class="t-title">${t.title}</span>
              <span class="t-time">--:--</span>
            </li>`).join('');
          return `
            <article class="album-row" data-album="${name}">
              <div class="album-art-col"><img class="album-art" src="${data.art}" alt="${name} album art"></div>
              <div class="playlist-col">
                <header class="playlist-head">
                  <h3>${name}</h3>
                  <button class="icon-btn play-all" title="Play all in ${name}">
                    <!-- no forced color param: CSS will recolor -->
                    <img src="https://api.iconify.design/mdi/playlist-play.svg" width="18" height="18" alt="">
                  </button>
                </header>
                <ul class="track-list">${items}</ul>
              </div>
            </article>`;
        }).join('');
    }
    renderAlbums();

    // durations
    albumsView.querySelectorAll('.track-row').forEach(li=>{
      const a = new Audio(); a.src = li.dataset.src; a.preload='metadata';
      a.addEventListener('loadedmetadata', ()=>{ li.querySelector('.t-time').textContent = formatTime(a.duration); });
    });

    // ---------- playback state ----------
    let scope='album';              // 'album' or 'all'
    let queue=[], index=0;
    const allQueue = Object.entries(albumsMap).flatMap(([n,d]) => d.tracks);
    let currentAlbum = Object.keys(albumsMap)[0] || null;

    // Toggles
    // scopeMode: what PLAY applies to from the bar
    // 'all' = full library, 'track' = single current track
    let scopeMode = 'all';          // default selected is "play all"
    let loopMode  = 'off';          // 'off' | 'all' | 'one'
    let shuffleOn = false;

    // ---------- queue helpers ----------
    function baseQueueForScope(){
      return (scope === 'all') ? allQueue.slice()
        : (currentAlbum ? albumsMap[currentAlbum].tracks.slice() : []);
    }
    function shuffleArray(a){
      for (let i=a.length-1;i>0;i--){ const j=(Math.random()* (i+1))|0; [a[i],a[j]]=[a[j],a[i]]; }
      return a;
    }
    function rebuildQueue(keepTrack){
      let base = baseQueueForScope();
      if (shuffleOn) base = shuffleArray(base);
      if (scopeMode === 'track' && keepTrack){
        queue = [keepTrack];
        index = 0;
      } else {
        queue = base;
        index = keepTrack ? Math.max(0, queue.findIndex(t => t.src === keepTrack.src)) : 0;
      }
    }

    function setAlbumQueue(name){
      scope='album';
      currentAlbum = name;
      rebuildQueue();
      document.querySelectorAll('.album-row').forEach(r=> r.classList.toggle('active', r.dataset.album===name));
    }

    function applyArt(t){
      nowArt.src = t ? albumsMap[t.album].art : CD_PLACEHOLDER;
      nowArt.alt = t ? `${t.album} art` : 'No track selected';
      stageArt.src = t ? albumsMap[t.album].art : '';
    }

    function loadTrackBySrc(src){
      // ensure queue contains this source
      const inAlbum = scope === 'album' && currentAlbum && albumsMap[currentAlbum].tracks.some(tr => tr.src === src);
      if (!inAlbum && scope === 'album'){
        // if user clicked a different album, switch scope.album
        const found = Object.keys(albumsMap).find(a => albumsMap[a].tracks.some(tr => tr.src === src));
        if (found){ setAlbumQueue(found); }
      }
      // Rebuild queue around this selection respecting scopeMode/shuffle
      const picked = (allQueue.find(t => t.src === src)) || null;
      if (picked){ rebuildQueue(picked); }

      const t = queue[index];
      audio.preload = 'auto';
      audio.src = t.src;
      audio.load();

      nowTitle.textContent = t.title; setTooltip(nowTitle, t.title);
      nowAlbum.textContent = t.album; setTooltip(nowAlbum, t.album);
      applyArt(t);
      hasSelection = true;

      document.querySelectorAll('.track-row').forEach(r=> r.classList.toggle('active', r.dataset.src===t.src));
    }

    // --- ICON STATE (class-based) ---
    function refreshPlayState() {
      const isPlaying = !audio.paused && !audio.ended && audio.readyState >= 2;
      iconPlay.classList.toggle('active', !isPlaying);
      iconPause.classList.toggle('active',  isPlaying);
      playBtn.setAttribute('aria-pressed', String(isPlaying));
    }

    // --- BUTTON ACTIONS ---
    async function play() {
      if (!hasSelection){
        // no selection yet: choose by scopeMode
        if (scopeMode === 'all'){
          scope = 'all';
          currentAlbum = null;
          rebuildQueue();
        } else {
          // single-track mode without a selection: pick first of first album
          const firstAlbum = Object.keys(albumsMap)[0];
          if (firstAlbum){ setAlbumQueue(firstAlbum); }
          if (queue.length) queue = [queue[0]], index = 0;
        }
        if (queue.length){ loadTrackBySrc(queue[index].src); }
      }
      // Loop mode -> audio.loop only for "one"
      audio.loop = (loopMode === 'one');

      try { await audio.play(); } catch {}
      refreshPlayState();
    }
    function pause(){ audio.pause(); refreshPlayState(); }

    function next(auto=false){
      if (queue.length === 0) return;
      // stop at end if loop off and auto-advance reached tail
      const atTail = (index >= queue.length - 1);
      if (auto && loopMode === 'off' && atTail){
        pause();
        return;
      }
      index = atTail ? 0 : index + 1;
      loadTrackBySrc(queue[index].src);
      if (auto) window.aurora?.instant?.();
      play();
    }
    function prev(){
      if (queue.length === 0) return;
      index = (index - 1 + queue.length) % queue.length;
      loadTrackBySrc(queue[index].src);
      play();
    }

    // --- CONTROL WIRING ---
    playBtn.addEventListener('click', () => (audio.paused ? play() : pause()));
    nextBtn.addEventListener('click', ()=> next(false));
    prevBtn.addEventListener('click', prev);

    // Toggle scope: ‘all library’ <-> ‘single track’
    toggleScopeBtn.addEventListener('click', ()=>{
      scopeMode = (scopeMode === 'all') ? 'track' : 'all';
      // Icon shows *the action you’ll switch to* on next click
      toggleScopeBtn.querySelector('.scope-all')?.classList.toggle('active', scopeMode === 'track');
      toggleScopeBtn.querySelector('.scope-one')?.classList.toggle('active', scopeMode === 'all');
      toggleScopeBtn.title = (scopeMode === 'all') ? 'Switch to play 1 track' : 'Switch to play ALL (library)';
      // Rebuild queue around current track if we have one
      if (hasSelection){
        const t = queue[index];
        rebuildQueue(t);
      }
    });

    // Loop tri-state
    loopBtn.addEventListener('click', ()=>{
      loopMode = (loopMode === 'off') ? 'all' : (loopMode === 'all' ? 'one' : 'off');
      loopBtn.querySelector('.loop-off').classList.toggle('active', loopMode === 'off');
      loopBtn.querySelector('.loop-all').classList.toggle('active', loopMode === 'all');
      loopBtn.querySelector('.loop-one').classList.toggle('active', loopMode === 'one');
      loopBtn.title = (loopMode === 'off') ? 'Loop off' : (loopMode === 'all' ? 'Loop all' : 'Loop 1');
      audio.loop = (loopMode === 'one');
    });

    // Shuffle toggle
    shuffleBtn.addEventListener('click', ()=>{
      shuffleOn = !shuffleOn;
      shuffleBtn.querySelector('.shuffle-on').classList.toggle('active', shuffleOn);
      shuffleBtn.querySelector('.shuffle-off').classList.toggle('active', !shuffleOn);
      shuffleBtn.title = shuffleOn ? 'Shuffle on' : 'Shuffle off';
      // keep current track, rebuild around it
      if (hasSelection){
        const t = queue[index];
        rebuildQueue(t);
      }
    });

    // List actions
    albumsView.addEventListener('click', e=>{
      const row = e.target.closest('.track-row');
      const playAll = e.target.closest('.play-all');
      const albumRow = e.target.closest('.album-row');

      if (playAll && albumRow){
        // This play-all is album-only (as requested)
        setAlbumQueue(albumRow.dataset.album);
        // Respect scopeMode
        if (scopeMode === 'track'){
          const first = albumsMap[albumRow.dataset.album].tracks[0];
          loadTrackBySrc(first.src);
          queue = [first]; index = 0;
        } else {
          rebuildQueue(); // album scope; shuffle respected
        }
        play();
        return;
      }
      if (row){
        const album = row.dataset.album;
        if (scope!=='album' || !currentAlbum || currentAlbum !== album){
          setAlbumQueue(album);
        }
        loadTrackBySrc(row.dataset.src);
        if (scopeMode === 'track'){ queue = [queue[index]]; index = 0; }
        play();
      }
    });

    // Progress
    audio.addEventListener('timeupdate', ()=>{
      if (!isFinite(audio.duration)) return;
      seek.value = Math.floor(1000 * audio.currentTime / audio.duration);
      document.querySelector('.bar .neon').style.setProperty('--pct', (audio.currentTime / audio.duration) * 100);
      currTime.textContent = formatTime(audio.currentTime);
      durTime.textContent  = formatTime(audio.duration);
    });
    seek.addEventListener('input', ()=>{
      if (isFinite(audio.duration)){ audio.currentTime = (seek.value/1000) * audio.duration; }
    });

    audio.addEventListener('ended', ()=> {
      if (loopMode === 'one'){ /* audio.loop already handles */ return; }
      next(true);
    });

    // ---------- THEME-AWARE TRACK VIEW BACKGROUND ----------
    // Using the existing CSS rule:
    // .music-shell.track-bg { background: var(--stage-bg, <fallback>) }
    // We set --stage-bg according to the current theme.
    const DARK_STAGE_BG  = 'radial-gradient(120% 140% at 50% 25%, rgba(0,0,0,.36), rgba(0,0,0,.9))';
    const LIGHT_STAGE_BG = 'radial-gradient(120% 140% at 50% 25%, rgba(255,255,255,.35), rgba(0,0,0,.15))';

    function applyStageBG(){
      const isDark = document.body.getAttribute('data-theme') === 'dark';
      shell.style.setProperty('--stage-bg', isDark ? DARK_STAGE_BG : LIGHT_STAGE_BG);
    }

    // Watch for theme toggles while in track view
    const themeObserver = new MutationObserver(muts => {
      if ([...muts].some(m => m.attributeName === 'data-theme')) {
        if (shell.classList.contains('track-bg')) applyStageBG();
      }
    });
    themeObserver.observe(document.body, { attributes: true, attributeFilter: ['data-theme'] });

    // View mode switch
    function setMode(list){
      const isList = !!list;
      albumsView.classList.toggle('hidden', !isList);
      trackView.classList.toggle('hidden', isList);
      lightList.classList.toggle('on', isList);
      lightTrack.classList.toggle('on', !isList);
      shell.classList.toggle('track-bg', !isList);
      viewsWrap.classList.toggle('no-scroll', !isList);
      viewsWrap.scrollTop = 0;

      if (!isList) {
        // theme-aware background for track view
        applyStageBG();

        // Show CD placeholder on stage if nothing selected yet
        if (!hasSelection) {
          stageArt.src = CD_PLACEHOLDER;
          stageArt.alt = 'CD placeholder';
        }
        // elevate album art above everything visually
        stageArtWrap.style.position = 'relative';
        stageArtWrap.style.zIndex = '2147483647';
        musicSection.style.setProperty('z-index', '2147483646', 'important');
      } else {
        // back to list view -> let CSS theme control the shell bg
        shell.style.removeProperty('--stage-bg');
        stageArtWrap.style.removeProperty('z-index');
        musicSection.style.removeProperty('z-index');
      }
    }

    lightList.addEventListener('click', ()=> setMode(true));
    lightTrack.addEventListener('click', ()=> setMode(false));

    // Always recheck state
    [
      'play','playing','pause','ended',
      'timeupdate','seeking','seeked','ratechange',
      'loadeddata','canplay','waiting','stalled','suspend','emptied','abort'
    ].forEach(ev => audio.addEventListener(ev, refreshPlayState));

    function formatTime(t){
      const m=Math.floor(t/60);
      const s=Math.floor(t%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    }

    // Initial view: list; no auto-selection; CD placeholder shown in bar
    setMode(true);
    refreshPlayState();
  })();
  </script>

  <!-- Aurora visualizer -->
  <script src="./aurora.js"></script>
</section>
